{% extends 'teacher/base.html' %}
{% load static %}

{% block title %}上传习题 - 在线学习诊断系统{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">上传习题</h1>
</div>

<!-- 安全文件上传表单 -->
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card shadow-sm border-0 rounded-lg p-4 mb-5">
            <form method="post" enctype="multipart/form-data" id="uploadForm">
                {% csrf_token %}

                <!-- 提示信息 -->
                <div class="alert alert-info mb-4">
                    <i class="bi bi-info-circle"></i> 支持格式：Word(.docx)、Excel(.xlsx)、PDF(.pdf) | 单个文件最大：10MB | 请勿上传恶意文件
                </div>

                <!-- 课程选择（关联习题所属课程，可选） -->
                <div class="mb-4">
                    <label for="course" class="form-label fw-semibold">所属课程</label>
                    <select class="form-select form-select-lg border-secondary" id="course" name="course" required>
                        <option value="">-- 请选择课程 --</option>
                        {% for course in courses %}
                            <option value="{{ course.id }}">{{ course.name }}</option>
                        {% empty %}
                            <option value="">暂无课程，请先创建课程</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- 习题类型选择 -->
                <div class="mb-4">
                    <label for="exercise_type" class="form-label fw-semibold">习题类型</label>
                    <select class="form-select form-select-lg border-secondary" id="exercise_type" name="exercise_type" required>
                        <option value="choice">选择题</option>
                        <option value="judge">判断题</option>
                        <option value="fill">填空题</option>
                        <option value="essay">简答题</option>
                        <option value="mixed">混合题型</option>
                    </select>
                </div>

                <!-- 文件上传区域（拖拽+点击上传） -->
                <div class="mb-4">
                    <label class="form-label fw-semibold">选择文件</label>
                    <div class="border-2 border-dashed border-secondary rounded-lg p-5 text-center" id="dropArea">
                        <input type="file" id="fileInput" name="exercise_file" class="d-none"
                               accept=".docx,.xlsx,.pdf" multiple>
                        <i class="bi bi-cloud-upload text-primary fs-3 mb-2"></i>
                        <p class="mb-2">点击区域选择文件，或直接拖拽文件到此处</p>
                        <p class="text-muted small">支持多文件上传，单个文件不超过10MB</p>
                        <!-- 已选文件列表 -->
                        <div id="fileList" class="mt-3 d-flex flex-wrap gap-2"></div>
                    </div>
                </div>

                <!-- 习题描述（可选） -->
                <div class="mb-4">
                    <label for="description" class="form-label fw-semibold">习题描述</label>
                    <textarea class="form-control" id="description" name="description" rows="3"
                              placeholder="请输入习题相关说明（可选）"></textarea>
                </div>

                <!-- 提交按钮 -->
                <div class="d-flex gap-3">
                    <button type="submit" class="btn btn-primary btn-lg flex-grow-1" id="submitBtn">
                        <i class="bi bi-upload"></i> 确认上传
                    </button>
                    <button type="reset" class="btn btn-outline-secondary btn-lg" id="resetBtn">
                        <i class="bi bi-arrow-counterclockwise"></i> 重置
                    </button>
                </div>
            </form>
        </div>

        <!-- 上传历史记录（可选） -->
        <div class="card shadow-sm border-0 rounded-lg p-4">
            <h5 class="card-title mb-3"><i class="bi bi-clock-history"></i> 最近上传记录</h5>
            {% if upload_history %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>文件名</th>
                                <th>课程</th>
                                <th>类型</th>
                                <th>上传时间</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in upload_history %}
                                <tr>
                                    <td>{{ item.file_name }}</td>
                                    <td>{{ item.course_name }}</td>
                                    <td>{{ item.get_exercise_type_display }}</td>
                                    <td>{{ item.upload_time|date:"Y-m-d H:i" }}</td>
                                    <td>
                                        {% if item.status == 'success' %}
                                            <span class="badge bg-success">解析成功</span>
                                        {% else %}
                                            <span class="badge bg-danger">解析失败</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{% url 'teacher:download_exercise' item.id %}" class="btn btn-sm btn-outline-primary"
                                           title="下载">
                                            <i class="bi bi-download"></i>
                                        </a>
                                        <button class="btn btn-sm btn-outline-danger ms-1"
                                                onclick="confirmDelete('{% url 'teacher:delete_exercise' item.id %}')"
                                                title="删除">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center text-muted py-3">暂无上传记录</div>
            {% endif %}
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- 引入Bootstrap图标 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<script>
// 1. 拖拽上传功能
const dropArea = document.getElementById('dropArea');
const fileInput = document.getElementById('fileInput');
const fileList = document.getElementById('fileList');

// 拖拽事件
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

// 拖拽样式变化
['dragenter', 'dragover'].forEach(eventName => {
    dropArea.addEventListener(eventName, () => {
        dropArea.classList.add('border-primary', 'bg-primary-subtle');
    });
});

['dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, () => {
        dropArea.classList.remove('border-primary', 'bg-primary-subtle');
    });
});

// 处理文件放置
dropArea.addEventListener('drop', handleDrop, false);
function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    if (files.length > 0) {
        fileInput.files = files;
        renderFileList(files);
    }
}

// 点击选择文件后渲染列表
fileInput.addEventListener('change', () => {
    if (fileInput.files.length > 0) {
        renderFileList(fileInput.files);
    }
});

// 渲染已选文件列表
function renderFileList(files) {
    fileList.innerHTML = '';
    Array.from(files).forEach((file, index) => {
        // 验证文件大小和类型（前端二次验证）
        const isValid = validateFile(file);
        if (!isValid) return;

        const fileItem = document.createElement('div');
        fileItem.className = 'bg-light rounded px-3 py-2 d-flex align-items-center gap-2';
        fileItem.innerHTML = `
            <i class="bi bi-file-${getFileExtensionClass(file.name)} text-primary"></i>
            <span class="text-truncate" style="max-width: 150px;" title="${file.name}">${file.name}</span>
            <span class="text-muted small">(${formatFileSize(file.size)})</span>
            <button type="button" class="btn-close btn-sm" onclick="removeFile(${index})"></button>
        `;
        fileList.appendChild(fileItem);
    });
}

// 移除单个文件
function removeFile(index) {
    const files = Array.from(fileInput.files);
    files.splice(index, 1);
    fileInput.files = new FileListItems(files);
    renderFileList(fileInput.files);
}

// 模拟FileList（用于移除文件后更新）
class FileListItems {
    constructor(files) {
        this.length = files.length;
        files.forEach((file, index) => {
            this[index] = file;
        });
    }
}

// 2. 文件验证（前端基础验证，后端必须再验证）
function validateFile(file) {
    // 允许的文件类型
    const allowedTypes = [
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document', // docx
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // xlsx
        'application/pdf' // pdf
    ];
    const allowedExtensions = ['.docx', '.xlsx', '.pdf'];
    const fileExtension = file.name.slice(-5).toLowerCase(); // 取后缀（如.docx）

    // 验证文件类型
    if (!allowedTypes.includes(file.type) && !allowedExtensions.some(ext => file.name.endsWith(ext))) {
        alert(`文件 ${file.name} 类型不允许！仅支持docx、xlsx、pdf格式`);
        return false;
    }

    // 验证文件大小（10MB = 10 * 1024 * 1024 = 10485760 bytes）
    const maxSize = 10 * 1024 * 1024;
    if (file.size > maxSize) {
        alert(`文件 ${file.name} 过大！单个文件最大支持10MB`);
        return false;
    }

    return true;
}

// 辅助函数：格式化文件大小
function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

// 辅助函数：根据文件后缀获取图标类
function getFileExtensionClass(fileName) {
    const ext = fileName.slice(-4).toLowerCase();
    if (ext === 'docx') return 'doc';
    if (ext === 'xlsx') return 'excel';
    if (ext === '.pdf') return 'pdf';
    return 'default';
}

// 3. 表单提交前验证
document.getElementById('uploadForm').addEventListener('submit', (e) => {
    if (fileInput.files.length === 0) {
        alert('请选择要上传的文件！');
        e.preventDefault();
        return;
    }

    // 禁用提交按钮防止重复提交
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="bi bi-spinner bi-spin"></i> 上传中...';
});

// 4. 删除确认
function confirmDelete(url) {
    if (confirm('确定要删除该习题文件吗？删除后不可恢复！')) {
        window.location.href = url;
    }
}

// 5. 重置按钮事件
document.getElementById('resetBtn').addEventListener('click', () => {
    fileList.innerHTML = '';
});
</script>
{% endblock %}