{% extends 'teacher/base.html' %}
{% load static %}

{% block title %}上传习题 - 在线学习诊断系统{% endblock %}

{% block content %}

<!-- 右侧主内容区域 -->

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">上传习题</h1>
</div>

<!-- 安全文件上传表单 -->
<div class="row justify-content-center">
<div class="col-md-8 col-lg-6">
    <div class="card shadow-sm border-0 rounded-lg p-4 mb-5">
        <!-- 提示信息 -->
        <div class="alert alert-info mb-4">
            <i class="bi bi-info-circle"></i> 支持格式：Word(.docx)、Excel(.xlsx)、PDF(.pdf) | 单个文件最大：10MB | 请勿上传恶意文件
        </div>

        <form method="post" enctype="multipart/form-data" id="uploadForm">
            {% csrf_token %}

            <!-- 科目选择 -->
            <div class="mb-4">
                <label for="{{ form.subject.id_for_label }}" class="form-label fw-semibold">{{ form.subject.label }}</label>
                {{ form.subject }}
                {% if form.subject.errors %}
                    <div class="text-danger small mt-1">{{ form.subject.errors }}</div>
                {% endif %}
            </div>

            <!-- 文件上传区域（拖拽+点击上传） -->
            <div class="mb-4">
                <label for="{{ form.file.id_for_label }}" class="form-label fw-semibold">{{ form.file.label }}</label>
                <div class="border-2 border-dashed border-secondary rounded-lg p-5 text-center" id="dropArea">
                    {{ form.file }}
                    <i class="bi bi-cloud-upload text-primary fs-3 mb-2"></i>
                    <p class="mb-2">点击区域选择文件，或直接拖拽文件到此处</p>
                    <p class="text-muted small">支持多文件上传，单个文件不超过10MB</p>
                    <!-- 已选文件列表 -->
                    <div id="fileList" class="mt-3 d-flex flex-wrap gap-2"></div>
                </div>
                {% if form.file.errors %}
                    <div class="text-danger small mt-1">{{ form.file.errors }}</div>
                {% endif %}
            </div>

            <!-- 提交按钮 -->
            <div class="d-flex gap-3">
                <button type="submit" class="btn btn-primary btn-lg flex-grow-1" id="submitBtn">
                    <i class="bi bi-upload"></i> 确认上传
                </button>
                <button type="reset" class="btn btn-outline-secondary btn-lg" id="resetBtn">
                    <i class="bi bi-arrow-counterclockwise"></i> 重置
                </button>
            </div>
        </form>
    </div>

    <!-- 上传历史记录 -->
    <div class="card shadow-sm border-0 rounded-lg p-4">
        <h5 class="card-title mb-3"><i class="bi bi-clock-history"></i> 最近上传记录</h5>
        {% if upload_history %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>文件名</th>
                            <th>科目</th>
                            <th>文件类型</th>
                            <th>上传时间</th>
                            <th>状态</th>
                            <th>习题数量</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for file in upload_history %}
                            <tr>
                                <td class="text-truncate" style="max-width: 150px;" title="{{ file.original_filename }}">
                                    {{ file.original_filename }}
                                </td>
                                <td>{{ file.subject.name }}</td>
                                <td>
                                    <span class="badge bg-secondary">{{ file.get_file_type_display }}</span>
                                </td>
                                <td>{{ file.uploaded_at|date:"Y-m-d H:i" }}</td>
                                <td>
                                    {% if file.status == 'completed' %}
                                        <span class="badge bg-success">已完成</span>
                                    {% elif file.status == 'processing' %}
                                        <span class="badge bg-warning">处理中</span>
                                    {% elif file.status == 'error' %}
                                        <span class="badge bg-danger">处理失败</span>
                                    {% else %}
                                        <span class="badge bg-info">待处理</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if file.exercise_count > 0 %}
                                        <span class="badge bg-primary">{{ file.exercise_count }} 题</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        {% if file.status == 'completed' and file.exercise_count > 0 %}
                                            <a href="#" class="btn btn-outline-success" title="查看习题">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                        {% endif %}
                                        <a href="{{ file.file.url }}" class="btn btn-outline-primary" title="下载原文件" download>
                                            <i class="bi bi-download"></i>
                                        </a>
                                        <button class="btn btn-outline-danger"
                                                onclick="confirmDelete('{% url 'delete_exercise_file' file.id %}')"
                                                title="删除">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center text-muted py-3">
                <i class="bi bi-inbox fs-1"></i>
                <p class="mt-2">暂无上传记录</p>
            </div>
        {% endif %}
    </div>
</div>
</div>





{% endblock %}

{% block extra_js %}
<!-- 引入Bootstrap图标 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<style>
    /* 文件上传区域样式 */
    .border-dashed {
        border-style: dashed !important;
    }
    #dropArea {
        transition: all 0.3s ease;
        cursor: pointer;
    }

    #dropArea:hover {
        border-color: #0d6efd !important;
        background-color: rgba(13, 110, 253, 0.05);
    }

</style>
<script>
// 1. 初始化文件输入框样式
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('{{ form.file.id_for_label }}');
    fileInput.classList.add('d-none'); // 隐藏原始文件输入框

    // 美化表单控件
    const subjectSelect = document.getElementById('{{ form.subject.id_for_label }}');
    if (subjectSelect) {
        subjectSelect.classList.add('form-select', 'form-select-lg', 'border-secondary');
    }
});

// 2. 拖拽上传功能
const dropArea = document.getElementById('dropArea');
const fileInput = document.getElementById('{{ form.file.id_for_label }}');
const fileList = document.getElementById('fileList');

// 点击dropArea触发文件选择
dropArea.addEventListener('click', () => {
    fileInput.click();
});

// 拖拽事件
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

// 拖拽样式变化
['dragenter', 'dragover'].forEach(eventName => {
    dropArea.addEventListener(eventName, () => {
        dropArea.classList.add('border-primary', 'bg-primary-subtle');
    });
});

['dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, () => {
        dropArea.classList.remove('border-primary', 'bg-primary-subtle');
    });
});

// 处理文件放置
dropArea.addEventListener('drop', handleDrop, false);
function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    if (files.length > 0) {
        updateFileInput(files);
        renderFileList(files);
    }
}

// 文件选择变化
fileInput.addEventListener('change', () => {
    if (fileInput.files.length > 0) {
        renderFileList(fileInput.files);
    }
});

// 更新文件输入框
function updateFileInput(files) {
    const dataTransfer = new DataTransfer();
    Array.from(files).forEach(file => {
        if (validateFile(file)) {
            dataTransfer.items.add(file);
        }
    });
    fileInput.files = dataTransfer.files;
}

// 渲染已选文件列表
function renderFileList(files) {
    fileList.innerHTML = '';
    const validFiles = Array.from(files).filter(file => validateFile(file, true));

    if (validFiles.length === 0) {
        return;
    }

    validFiles.forEach((file, index) => {
        const fileItem = document.createElement('div');
        fileItem.className = 'bg-light rounded px-3 py-2 d-flex align-items-center gap-2';
        fileItem.innerHTML = `
            <i class="bi bi-file-${getFileExtensionClass(file.name)} text-primary"></i>
            <span class="text-truncate" style="max-width: 150px;" title="${file.name}">${file.name}</span>
            <span class="text-muted small">(${formatFileSize(file.size)})</span>
            <button type="button" class="btn-close btn-sm" onclick="removeFile(${index})"></button>
        `;
        fileList.appendChild(fileItem);
    });
}

// 移除单个文件
function removeFile(index) {
    const files = Array.from(fileInput.files);
    files.splice(index, 1);

    const dataTransfer = new DataTransfer();
    files.forEach(file => dataTransfer.items.add(file));
    fileInput.files = dataTransfer.files;

    renderFileList(fileInput.files);
}

// 3. 文件验证（前端基础验证，后端必须再验证）
function validateFile(file, showAlert = false) {
    // 允许的文件类型
    const allowedTypes = [
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document', // docx
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // xlsx
        'application/pdf' // pdf
    ];
    const allowedExtensions = ['.docx', '.xlsx', '.pdf'];
    const fileExtension = '.' + file.name.split('.').pop().toLowerCase();

    // 验证文件类型
    if (!allowedTypes.includes(file.type) && !allowedExtensions.includes(fileExtension)) {
        if (showAlert) {
            alert(`文件 ${file.name} 类型不允许！仅支持docx、xlsx、pdf格式`);
        }
        return false;
    }

    // 验证文件大小（10MB = 10 * 1024 * 1024 = 10485760 bytes）
    const maxSize = 10 * 1024 * 1024;
    if (file.size > maxSize) {
        if (showAlert) {
            alert(`文件 ${file.name} 过大！单个文件最大支持10MB`);
        }
        return false;
    }

    return true;
}

// 辅助函数：格式化文件大小
function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

// 辅助函数：根据文件后缀获取图标类
function getFileExtensionClass(fileName) {
    const ext = fileName.split('.').pop().toLowerCase();
    if (ext === 'docx') return 'word';
    if (ext === 'xlsx') return 'excel';
    if (ext === 'pdf') return 'pdf';
    return 'default';
}

// 4. 表单提交前验证
document.getElementById('uploadForm').addEventListener('submit', (e) => {
    if (fileInput.files.length === 0) {
        alert('请选择要上传的文件！');
        e.preventDefault();
        return;
    }

    // 验证所有文件
    const files = Array.from(fileInput.files);
    const invalidFiles = files.filter(file => !validateFile(file));

    if (invalidFiles.length > 0) {
        alert('存在无效文件，请检查后重新上传！');
        e.preventDefault();
        return;
    }

    // 禁用提交按钮防止重复提交
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="bi bi-spinner bi-spin"></i> 上传中...';
});

// 5. 删除确认
function confirmDelete(url) {
    if (confirm('确定要删除该习题文件吗？删除后不可恢复！')) {
        // 使用表单提交删除请求
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = url;

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);

        document.body.appendChild(form);
        form.submit();
    }
}

// 6. 重置按钮事件
document.getElementById('resetBtn').addEventListener('click', () => {
    fileList.innerHTML = '';
    // 清空文件输入框
    fileInput.value = '';
});
</script>
{% endblock %}