<!-- templates/teacher/student_info.html -->
{% extends 'teacher/course_management_base.html' %}
{% load static %}

{% block title %}选课学生 - 在线学习诊断系统{% endblock %}

{% block content %}
<style>
    .badge-grade {
        background-color: #6f42c1;
        color: white;
    }

    .table-hover tbody tr:hover {
        background-color: #f8f9fa;
        cursor: pointer;
    }

    .filter-box {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
</style>

<!-- 统计卡片 -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            选课学生数
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_students }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-users fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 筛选和搜索 -->
<div class="filter-box">
    <div class="row">
        <div class="col-md-6 mb-3">
            <label class="form-label">搜索学生ID</label>
            <input type="text" class="form-control" placeholder="输入学生ID..." id="searchIdInput">
        </div>
        <div class="col-md-6 mb-3">
            <label class="form-label">搜索学生姓名</label>
            <div class="input-group">
                <input type="text" class="form-control" placeholder="输入学生姓名..." id="searchNameInput">
                <button class="btn btn-primary" type="button" id="searchBtn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 学生列表表格 -->
<div class="card shadow">
    <div class="card-header py-3 d-flex justify-content-between align-items-center">
        <div>
            <h6 class="m-0 font-weight-bold text-primary">学生列表</h6>
            
        </div>
        <button class="btn btn-sm btn-success" id="exportBtn">
            <i class="fas fa-download"></i> 导出学生列表
        </button>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>学生姓名</th>
                        <th>邮箱</th>
                        <th>年级</th>
                        <th>学校</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in students %}
                    <tr class="student-row">
                        <td>
                            <div class="fw-bold">
                                {{ student.first_name }}{{ student.last_name }}
                            </div>
                        </td>
                        <td>{{ student.email|default:"无邮箱" }}</td>
                        <td>
                            {% if student.studentprofile.grade %}
                                <span class="badge badge-grade">{{ student.studentprofile.grade }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if student.studentprofile.school %}
                                {{ student.studentprofile.school }}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center py-4">
                            {% if teacher_subjects.exists %}
                                <i class="fas fa-user-slash fa-2x text-muted mb-3"></i>
                                <p class="text-muted mb-0">当前科目暂无学生</p>
                            {% else %}
                                <i class="fas fa-book fa-2x text-muted mb-3"></i>
                                <p class="text-muted mb-0">您暂无授课科目</p>
                                <a href="{% url 'teacher_subject_management' %}" class="btn btn-sm btn-primary mt-2">
                                    <i class="fas fa-plus me-1"></i>申请授课
                                </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- 分页 -->
        {% if students.paginator.num_pages > 1 %}
        <div class="card-footer">
            <nav>
                <ul class="pagination justify-content-center mb-0">
                    {% if students.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ students.previous_page_number }}{% if current_subject %}&subject={{ current_subject.id }}{% endif %}">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                    {% endif %}

                    {% for num in students.paginator.page_range %}
                        {% if num >= students.number|add:"-2" and num <= students.number|add:"2" %}
                        <li class="page-item {% if students.number == num %}active{% endif %}">
                            <a class="page-link" href="?page={{ num }}{% if current_subject %}&subject={{ current_subject.id }}{% endif %}">{{ num }}</a>
                        </li>
                        {% endif %}
                    {% endfor %}

                    {% if students.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ students.next_page_number }}{% if current_subject %}&subject={{ current_subject.id }}{% endif %}">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 本地搜索功能 - 按ID和姓名筛选
    const searchIdInput = document.getElementById('searchIdInput');
    const searchNameInput = document.getElementById('searchNameInput');
    const searchBtn = document.getElementById('searchBtn');
    const studentRows = document.querySelectorAll('.student-row');

    function filterStudentsBySearch() {
        const searchId = searchIdInput.value.toLowerCase();
        const searchName = searchNameInput.value.toLowerCase();

        studentRows.forEach(row => {
            // 获取学生ID（从第一列的用户名中提取或从data属性）
            const studentIdCell = row.querySelector('td:first-child');
            const studentId = studentIdCell.textContent.toLowerCase();
            
            // 获取学生姓名（从第一列）
            const studentNameCell = row.querySelector('td:first-child .fw-bold');
            const studentName = studentNameCell ? studentNameCell.textContent.toLowerCase() : '';

            // 匹配ID或姓名
            const matchesId = searchId === '' || studentId.includes(searchId);
            const matchesName = searchName === '' || studentName.includes(searchName);

            row.style.display = (matchesId && matchesName) ? '' : 'none';
        });
    }

    if (searchBtn) {
        searchBtn.addEventListener('click', filterStudentsBySearch);
    }

    if (searchIdInput) {
        searchIdInput.addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                filterStudentsBySearch();
            }
        });
    }

    if (searchNameInput) {
        searchNameInput.addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                filterStudentsBySearch();
            }
        });
    }

    // 导出学生列表功能
    const exportBtn = document.getElementById('exportBtn');
    if (exportBtn) {
        exportBtn.addEventListener('click', function() {
            exportStudentList();
        });
    }

    function exportStudentList() {
        // 获取当前科目ID
        const urlParams = new URLSearchParams(window.location.search);
        const subjectId = urlParams.get('subject');
        
        // 调用后端API获取所有学生数据
        fetch(`/learning/api/export-students/?subject=${subjectId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 创建CSV内容
                    let csvContent = '学生姓名,邮箱,年级,学校\n';
                    
                    data.students.forEach(student => {
                        const studentName = student.name;
                        const email = student.email;
                        const grade = student.grade;
                        const school = student.school;
                        
                        // 处理包含逗号的数据，用引号包围
                        csvContent += `"${studentName}","${email}","${grade}","${school}"\n`;
                    });
                    
                    // 创建Blob对象
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    
                    // 创建下载链接
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    
                    link.setAttribute('href', url);
                    link.setAttribute('download', `学生列表_${new Date().getTime()}.csv`);
                    link.style.visibility = 'hidden';
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    alert('导出失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('导出错误:', error);
                alert('导出出错，请重试');
            });
    }
});
</script>

{% endblock %}
