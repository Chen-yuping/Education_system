<!-- D:\Project\Learning platform\Github\Education_system\learning\templates\teacher\exercise_management.html -->
{% extends 'teacher/base.html' %}
{% load static %}

{% block title %}题库管理{% endblock %}

{% block content %}

{% if no_subjects %}
<div class="alert alert-warning" role="alert">
    <h4 class="alert-heading">您还没有分配授课科目</h4>
    <p>您目前没有分配任何授课科目，无法查看和管理习题。</p>
    <hr>
    <p class="mb-0">
        <a href="{% url 'teacher_subjects' %}" class="btn btn-primary">
            去分配授课科目
        </a>
    </p>
</div>
{% else %}

<!--主要模块-->
<div class="container-fluid">
    <!-- 页面标题和操作按钮 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">题库管理</h1>
            <p class="text-muted mb-0">管理所有习题，支持增删改查、批量操作</p>
        </div>
<!--        <div>-->
<!--            <button type="button" class="btn btn-danger mr-2" id="batchDeleteBtn" disabled>-->
<!--                <i class="fas fa-trash-alt"></i> 批量删除-->
<!--            </button>-->
<!--            <a href="{% url 'export_exercises' %}?{{ request.GET.urlencode }}" class="btn btn-success mr-2" id="exportBtn">-->
<!--                <i class="fas fa-download"></i> 导出习题-->
<!--            </a>-->
<!--            <a href="{% url 'exercise_add' %}" class="btn btn-primary">-->
<!--                <i class="fas fa-plus"></i> 添加习题-->
<!--            </a>-->
<!--        </div>-->
    </div>

    <!-- 筛选和搜索区域 -->
    <div class="card shadow mb-4">
        <div class="card-body">
            <form id="filterForm" method="get" class="row g-3">
                <div class="col-md-3">
                    <label for="subjectFilter" class="form-label">科目</label>
                    <select class="form-select" id="subjectFilter" name="subject">
                        <option value="">全部科目</option>
                        {% for subject in subjects %}
                        <option value="{{ subject.id }}" {% if request.GET.subject == subject.id|stringformat:'s' %}selected{% endif %}>
                            {{ subject.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-3">
                    <label for="typeFilter" class="form-label">题型</label>
                    <select class="form-select" id="typeFilter" name="question_type">
                        <option value="">全部题型</option>
                        <option value="1" {% if request.GET.question_type == '1' %}selected{% endif %}>单选题</option>
                        <option value="2" {% if request.GET.question_type == '2' %}selected{% endif %}>多选题</option>
                        <option value="3" {% if request.GET.question_type == '3' %}selected{% endif %}>投票题</option>
                        <option value="4" {% if request.GET.question_type == '4' %}selected{% endif %}>填空题</option>
                        <option value="5" {% if request.GET.question_type == '5' %}selected{% endif %}>主观题</option>
                        <option value="6" {% if request.GET.question_type == '6' %}selected{% endif %}>判断题</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label for="knowledgeFilter" class="form-label">知识点</label>
                    <select class="form-select" id="knowledgeFilter" name="knowledge_point">
                        <option value="">全部知识点</option>
                        {% for knowledge in knowledge_points %}
                        <option value="{{ knowledge.id }}" {% if request.GET.knowledge_point == knowledge.id|stringformat:'s' %}selected{% endif %}>
                            {{ knowledge.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-3">
                    <label for="creatorFilter" class="form-label">创建者</label>
                    <select class="form-select" id="creatorFilter" name="creator">
                        <option value="">全部创建者</option>
                        {% for creator in creators %}
                        <option value="{{ creator.id }}" {% if request.GET.creator == creator.id|stringformat:'s' %}selected{% endif %}>
                            {{ creator.username }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-6">
                    <label for="searchInput" class="form-label">搜索</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="searchInput" name="search"
                               placeholder="搜索习题标题或内容" value="{{ request.GET.search|default:'' }}">
                        <button class="btn btn-outline-primary" type="submit">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>

                <div class="col-md-6">
                    <label class="form-label">创建时间</label>
                    <div class="row g-2">
                        <div class="col">
                            <input type="date" class="form-control" id="startDate" name="start_date"
                                   value="{{ request.GET.start_date|default:'' }}">
                        </div>
                        <div class="col-auto d-flex align-items-center">至</div>
                        <div class="col">
                            <input type="date" class="form-control" id="endDate" name="end_date"
                                   value="{{ request.GET.end_date|default:'' }}">
                        </div>
                    </div>
                </div>

                <div class="col-md-12 d-flex justify-content-end">
                    <button type="button" class="btn btn-outline-secondary me-2" id="resetFilters">
                        <i class="fas fa-redo"></i> 重置筛选
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-filter"></i> 筛选
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 习题列表表格 -->
    <div class="card shadow">
        <div class="card-body">
            {% if exercises %}
            <div class="table-responsive">
                <table class="table table-hover" id="exerciseTable">
                    <thead>
                        <tr>
                            <th width="50">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="selectAll">
                                </div>
                            </th>
                            <th>ID</th>
                            <th>习题标题</th>
                            <th>科目</th>
                            <th>题型</th>
                            <th>创建者</th>
                            <th>关联知识点</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for exercise in exercises %}
                        <tr>
                            <td>
                                <div class="form-check">
                                    <input class="form-check-input exercise-checkbox" type="checkbox"
                                           value="{{ exercise.id }}">
                                </div>
                            </td>
                            <td>{{ exercise.id }}</td>
                            <td>
                                <a href="javascript:void(0);"
                                   onclick="showExerciseDetail({{ exercise.id }})"
                                   class="text-decoration-none exercise-detail-link"
                                   title="点击查看详情"
                                   data-bs-toggle="tooltip" data-bs-placement="top">
                                    {{ exercise.title|truncatechars:30 }}
                                </a>

                                <br><small class="text-muted">{{ exercise.content|truncatechars:50 }}</small>

                            </td>
                            <td>{{ exercise.subject.name }}</td>
                            <td>
                                {% if exercise.question_type == '1' %}
                                <span class="badge bg-primary">单选题</span>
                                {% elif exercise.question_type == '2' %}
                                <span class="badge bg-success">多选题</span>
                                {% elif exercise.question_type == '3' %}
                                <span class="badge bg-warning">投票题</span>
                                {% elif exercise.question_type == '4' %}
                                <span class="badge bg-info">填空题</span>
                                {% elif exercise.question_type == '5' %}
                                <span class="badge bg-warning">主观题</span>
                                {% elif exercise.question_type == '6' %}
                                <span class="badge bg-info">判断题</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ exercise.question_type }}</span>
                                {% endif %}
                            </td>
                            <td>{{ exercise.creator.username|default:"-" }}</td>
                            <td>
                                {% with knowledge_points=exercise.qmatrix_set.all %}
                                {% if knowledge_points %}
                                    <div class="d-flex flex-wrap gap-1" style="max-width: 150px;">
                                    {% for qmatrix in knowledge_points|slice:":3" %}
                                        <span class="badge bg-light text-dark"
                                              data-bs-toggle="tooltip"
                                              title="{{ qmatrix.knowledge_point.name }}">
                                            {{ qmatrix.knowledge_point.name|truncatechars:10 }}
                                        </span>
                                    {% endfor %}
                                    {% if knowledge_points.count > 3 %}
                                        <span class="badge bg-secondary"
                                              data-bs-toggle="tooltip"
                                              title="还有{{ knowledge_points.count|add:'-3' }}个知识点">
                                            +{{ knowledge_points.count|add:"-3" }}
                                        </span>
                                    {% endif %}
                                    </div>
                                {% else %}
                                    <span class="text-muted">未关联</span>
                                {% endif %}
                                {% endwith %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="javascript:void(0);"
                                       onclick="showExerciseDetail({{ exercise.id }})"
                                       class="btn btn-outline-info"
                                       data-bs-toggle="tooltip"
                                       title="查看详情">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{% url 'exercise_update_json' exercise.id %}"
                                       class="btn btn-outline-warning"
                                       data-bs-toggle="tooltip"
                                       title="编辑">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button type="button"
                                            class="btn btn-outline-danger delete-exercise"
                                            data-id="{{ exercise.id }}"
                                            data-title="{{ exercise.title }}"
                                            data-bs-toggle="tooltip"
                                            title="删除">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- 分页 -->
            {% if exercises.has_other_pages %}
            <nav aria-label="Page navigation" class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if exercises.has_previous %}
                    <li class="page-item">
                        <a class="page-link"
                           href="?page={{ exercises.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                    {% endif %}

                    {% for num in exercises.paginator.page_range %}
                        {% if num >= exercises.number|add:"-2" and num <= exercises.number|add:"2" %}
                            {% if exercises.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                            {% else %}
                            <li class="page-item">
                                <a class="page-link"
                                   href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                    {{ num }}
                                </a>
                            </li>
                            {% endif %}
                        {% endif %}
                    {% endfor %}

                    {% if exercises.has_next %}
                    <li class="page-item">
                        <a class="page-link"
                           href="?page={{ exercises.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
                <p class="text-center text-muted mt-2">
                    第 {{ exercises.number }} 页，共 {{ exercises.paginator.num_pages }} 页，
                    总共 {{ exercises.paginator.count }} 条记录
                </p>
            </nav>
            {% endif %}

            {% else %}
            <!-- 空状态 -->
            <div class="text-center py-5">
                <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
                <h5 class="text-muted">暂无习题数据</h5>
                <p class="text-muted mb-4">您还没有添加任何习题，或者筛选条件没有匹配到任何结果</p>
                <a href="{% url 'exercise_add' %}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>添加习题
                </a>
                <button type="button" class="btn btn-outline-secondary ms-2" id="clearFilters">
                    <i class="fas fa-redo me-2"></i>清除筛选条件
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 习题详情模态框 -->
<div class="modal fade" id="exerciseDetailModal" tabindex="-1" aria-labelledby="exerciseDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="exerciseDetailModalLabel">
                    <i class="fas fa-question-circle me-2"></i>习题详情
                    <span id="exercise-id-badge" class="badge bg-light text-dark ms-2"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="exercise-detail-content">
                <!-- 内容将通过JavaScript动态加载 -->
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <p class="mt-2">正在加载习题详情...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <a id="edit-exercise-btn" href="#" class="btn btn-warning">
                        <i class="fas fa-edit me-1"></i>编辑
                    </a>
                <button type="button" class="btn btn-danger" onclick="deleteExercise()">
                    <i class="fas fa-trash-alt me-1"></i>删除
                </button>
            </div>
        </div>
    </div>
</div>
<!-- 习题编辑模态框 -->
<div class="modal fade" id="exerciseEditModal" tabindex="-1" aria-labelledby="exerciseEditModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title" id="exerciseEditModalLabel">
                    <i class="fas fa-edit me-2"></i>编辑习题
                    <span id="edit-exercise-id-badge" class="badge bg-light text-dark ms-2"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="exerciseEditForm">
                <div class="modal-body">
                    <!-- 内容将通过JavaScript动态加载 -->
                    <div class="text-center py-5">
                        <div class="spinner-border text-warning" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <p class="mt-2">正在加载编辑表单...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-warning" id="save-edit-btn">
                        <i class="fas fa-save me-1"></i>保存更改
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- 删除确认模态框 -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">确认删除</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>确定要删除习题 "<span id="exerciseTitle" class="fw-bold"></span>" 吗？</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    此操作将永久删除该习题及其所有相关数据，包括：
                    <ul class="mb-0 mt-2">
                        <li>习题基本信息</li>
                        <li>所有选项</li>
                        <li>Q矩阵关联关系</li>
                        <li>学生的答题记录</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <form id="deleteForm" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">确认删除</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endif %}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
// 全局变量，存储当前选中的习题ID
let currentExerciseId = null;

// 显示习题详情模态框
function showExerciseDetail(exerciseId) {
    currentExerciseId = exerciseId;

    // 更新编辑按钮的链接
    const editBtn = document.getElementById('edit-exercise-btn');
    editBtn.href = `/learning/exercise-management/edit/${exerciseId}/`;

    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('exerciseDetailModal'));
    modal.show();

    // 加载习题详情数据
    loadExerciseDetail(exerciseId);
}

// 加载习题详情
function loadExerciseDetail(exerciseId) {
    const contentDiv = document.getElementById('exercise-detail-content');

    // 显示加载中
    contentDiv.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
            <p class="mt-2">正在加载习题详情...</p>
        </div>
    `;

    // 发送AJAX请求获取习题详情
    fetch(`/learning/exercise-management/detail/${exerciseId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderExerciseDetail(data.exercise);
            } else {
                contentDiv.innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        <h5 class="alert-heading">加载失败</h5>
                        <p>${data.message || '无法加载习题详情'}</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('加载习题详情失败:', error);
            contentDiv.innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <h5 class="alert-heading">加载失败</h5>
                    <p>网络错误，请稍后重试。</p>
                </div>
            `;
        });
}

// 渲染习题详情
function renderExerciseDetail(exercise) {
    const contentDiv = document.getElementById('exercise-detail-content');
    const idBadge = document.getElementById('exercise-id-badge');

    // 更新ID徽章
    idBadge.textContent = `ID: ${exercise.id}`;

    // 生成知识点标签HTML
    let knowledgePointsHtml = '';
    if (exercise.knowledge_points && exercise.knowledge_points.length > 0) {
        exercise.knowledge_points.forEach(kp => {
            knowledgePointsHtml += `
                <span class="badge bg-primary me-1 mb-1">
                    ${kp.knowledge_point__name || kp.name || '未命名'}
                    ${kp.weight ? `<span class="badge bg-light text-dark ms-1">${kp.weight}</span>` : ''}
                </span>
            `;
        });
    } else {
        knowledgePointsHtml = '<p class="text-muted">未关联知识点</p>';
    }

    // 生成HTML内容
    contentDiv.innerHTML = `
        <!-- 基本信息 -->
        <div class="mb-4">
            <h4>${exercise.title || '无标题'}</h4>
            <div class="mb-2">
                <span class="badge bg-info text-dark me-1">${exercise.subject || '未分类'}</span>
                <span class="badge bg-secondary me-1">${exercise.question_type || '未知题型'}</span>

            </div>
        </div>

        <!-- 习题内容 -->
        <div class="mb-4">
            <h6><i class="fas fa-text-paragraph me-1"></i> 习题内容：</h6>
            <div class="border rounded p-3 bg-light">
    <!-- 显示题目内容 -->
    ${exercise.content ? exercise.content.replace(/\n/g, '<br>') : '<span class="text-muted">无内容</span>'}

    <!-- 显示选项（如果存在） -->
    ${exercise.option_text ?
        (() => {
            try {
                // 首先尝试直接解析
                const options = JSON.parse(exercise.option_text);
                return formatOptions(options);
            } catch (e1) {
                try {
                    // 如果失败，尝试替换单引号为双引号
                    const fixedStr = exercise.option_text
                        .replace(/'/g, '"')
                        .replace(/(\w+):/g, '"$1":');  // 处理键名
                    const options = JSON.parse(fixedStr);
                    return formatOptions(options);
                } catch (e2) {
                    try {
                        // 如果还是失败，尝试手动解析类似Python字典的格式
                        const str = exercise.option_text.trim();
                        if (str.startsWith('{') && str.endsWith('}')) {
                            const content = str.slice(1, -1);
                            const pairs = content.split(',');
                            const options = {};
                            pairs.forEach(pair => {
                                const [key, value] = pair.split(':').map(s => s.trim());
                                // 移除引号
                                const cleanKey = key.replace(/['"`]/g, '');
                                const cleanValue = value ? value.replace(/['"`]/g, '') : '';
                                options[cleanKey] = cleanValue;
                            });
                            return formatOptions(options);
                        }
                    } catch (e3) {
                        // 所有解析都失败，直接显示原始文本
                        return `<div class="mt-3"><strong>选项：</strong><br>${exercise.option_text.replace(/\n/g, '<br>')}</div>`;
                    }
                }
            }

            // 格式化选项的辅助函数
            function formatOptions(options) {
                if (!options || typeof options !== 'object') {
                    return `<div class="mt-3">${exercise.option_text.replace(/\n/g, '<br>')}</div>`;
                }

                const formattedOptions = Object.entries(options)
                    .sort(([keyA], [keyB]) => keyA.localeCompare(keyB))
                    .map(([key, value]) => `<strong>${key}:</strong> ${value || ''}`)
                    .join('<br>');

                return `<div class="mt-3">${formattedOptions}</div>`;
            }
        })()
        : ''
    }
</div>
        </div>

        <!-- 答案和解析 -->
        <div class="row mb-4">
            <div class="col-md-6">
                <h6><i class="fas fa-check-circle me-1"></i> 参考答案：</h6>
                <div class="border rounded p-3 bg-light">
                    ${exercise.answer ? exercise.answer.replace(/\n/g, '<br>') : '<span class="text-muted">暂无答案</span>'}
                </div>
            </div>
            <div class="col-md-6">
                <h6><i class="fas fa-lightbulb me-1"></i> 答案解析：</h6>
                <div class="border rounded p-3 bg-light">
                    ${exercise.solution ? exercise.solution.replace(/\n/g, '<br>') : '<span class="text-muted">暂无解析</span>'}
                </div>
            </div>
        </div>

        <!-- 知识点 -->
        <div class="mb-4">
            <h6><i class="fas fa-tags me-1"></i> 关联知识点：</h6>
            <div class="d-flex flex-wrap">
                ${knowledgePointsHtml}
            </div>
        </div>


    `;
}
// 全局变量
let currentEditExerciseId = null;
let currentEditExerciseData = null;

// 显示编辑模态框
function showExerciseEdit(exerciseId) {
    currentEditExerciseId = exerciseId;

    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('exerciseEditModal'));
    modal.show();

    // 加载习题数据用于编辑
    loadExerciseForEdit(exerciseId);
}

// 加载习题数据用于编辑
function loadExerciseForEdit(exerciseId) {
    const contentDiv = document.getElementById('exerciseEditModal').querySelector('.modal-body');

    // 显示加载中
    contentDiv.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-warning" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
            <p class="mt-2">正在加载编辑表单...</p>
        </div>
    `;

    // 发送AJAX请求获取习题详情
    fetch(`/learning/exercise-management/detail/${exerciseId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentEditExerciseData = data.exercise;
                renderExerciseEditForm(data.exercise);
            } else {
                contentDiv.innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        <h5 class="alert-heading">加载失败</h5>
                        <p>${data.message || '无法加载习题数据'}</p>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    </div>
                `;
                document.getElementById('save-edit-btn').style.display = 'none';
            }
        })
        .catch(error => {
            console.error('加载习题编辑数据失败:', error);
            contentDiv.innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <h5 class="alert-heading">加载失败</h5>
                    <p>网络错误，请稍后重试。</p>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            `;
            document.getElementById('save-edit-btn').style.display = 'none';
        });
}

// 渲染编辑表单
function renderExerciseEditForm(exercise) {
    const contentDiv = document.getElementById('exerciseEditModal').querySelector('.modal-body');
    const idBadge = document.getElementById('edit-exercise-id-badge');

    // 更新ID徽章
    idBadge.textContent = `ID: ${exercise.id}`;

    // 题型选项 - 与您的模型保持一致
    const questionTypeOptions = {
        'single': '单选题',
        'multiple': '多选题',
        'judgment': '判断题',
        'fill': '填空题',
        'subjective': '主观题'
    };

    // 生成题型选择HTML
    let questionTypeOptionsHtml = '';
    for (const [value, label] of Object.entries(questionTypeOptions)) {
        const selected = exercise.question_type === value ? 'selected' : '';
        questionTypeOptionsHtml += `<option value="${value}" ${selected}>${label}</option>`;
    }

    // 生成科目选择HTML
    let subjectOptionsHtml = '';
    if (exercise.teacher_subjects && exercise.teacher_subjects.length > 0) {
        exercise.teacher_subjects.forEach(subject => {
            const selected = exercise.subject_id === subject.id ? 'selected' : '';
            subjectOptionsHtml += `<option value="${subject.id}" ${selected}>${subject.name}</option>`;
        });
    } else {
        subjectOptionsHtml = '<option value="">无可用科目</option>';
    }

    // 生成知识点选择HTML（带权重）
    let knowledgePointsHtml = '';
    if (exercise.subject_knowledge_points && exercise.subject_knowledge_points.length > 0) {
        // 创建已选知识点的映射
        const selectedKnowledgePoints = {};
        if (exercise.knowledge_points) {
            exercise.knowledge_points.forEach(kp => {
                selectedKnowledgePoints[kp.knowledge_point__id] = kp.weight;
            });
        }

        exercise.subject_knowledge_points.forEach(kp => {
            const isSelected = selectedKnowledgePoints.hasOwnProperty(kp.id);
            const weight = isSelected ? selectedKnowledgePoints[kp.id] : '1.0';
            knowledgePointsHtml += `
                <div class="row mb-2 align-items-center">
                    <div class="col">
                        <div class="form-check">
                            <input class="form-check-input knowledge-point-checkbox"
                                   type="checkbox"
                                   value="${kp.id}"
                                   id="edit_kp_${kp.id}"
                                   ${isSelected ? 'checked' : ''}>
                            <label class="form-check-label" for="edit_kp_${kp.id}">
                                ${kp.name}
                            </label>
                        </div>
                    </div>
                    <div class="col-3">
                        <input type="number"
                               class="form-control form-control-sm weight-input"
                               data-kp-id="${kp.id}"
                               min="0.1" max="10" step="0.1"
                               value="${weight}"
                               placeholder="权重"
                               ${!isSelected ? 'disabled' : ''}>
                    </div>
                </div>
            `;
        });
    } else {
        knowledgePointsHtml = '<p class="text-muted">该科目下暂无知识点</p>';
    }

    // 生成表单HTML
    contentDiv.innerHTML = `
        <div class="container-fluid">
            <form id="exerciseEditForm">
                <div class="row">
                    <div class="col-12">
                        <!-- 科目 -->
                        <div class="mb-3">
                            <label for="edit_subject" class="form-label fw-bold">所属科目 *</label>
                            <select class="form-select" id="edit_subject" name="subject_id" required>
                                ${subjectOptionsHtml}
                            </select>
                        </div>

                        <!-- 标题 -->
                        <div class="mb-3">
                            <label for="edit_title" class="form-label fw-bold">习题标题 *</label>
                            <input type="text" class="form-control" id="edit_title"
                                   name="title" value="${exercise.title || ''}" required>
                        </div>

                        <!-- 题型 -->
                        <div class="mb-3">
                            <label for="edit_question_type" class="form-label fw-bold">题型 *</label>
                            <select class="form-select" id="edit_question_type" name="question_type" required>
                                ${questionTypeOptionsHtml}
                            </select>
                        </div>

                        <!-- 内容 -->
                        <div class="mb-3">
                            <label for="edit_content" class="form-label fw-bold">习题内容 *</label>
                            <textarea class="form-control" id="edit_content" name="content"
                                      rows="4" required>${exercise.content || ''}</textarea>
                        </div>

                        <!-- 选项 -->
                        <div class="mb-3" id="edit_options_section">
                            <label for="edit_option_text" class="form-label fw-bold">选项内容</label>
                            <textarea class="form-control" id="edit_option_text" name="option_text"
                                      rows="3" placeholder="每行一个选项，例如：A. 选项一">${exercise.option_text || ''}</textarea>
                            <div class="form-text">每行一个选项，例如：A. 选项一</div>
                        </div>

                        <!-- 答案 -->
                        <div class="mb-3">
                            <label for="edit_answer" class="form-label fw-bold">参考答案 *</label>
                            <input type="text" class="form-control" id="edit_answer"
                                   name="answer" value="${exercise.answer || ''}" required>
                            <div class="form-text" id="edit_answer_hint"></div>
                        </div>

                        <!-- 知识点 -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">关联知识点</label>
                            <div class="border rounded p-3 bg-light">
                                <div class="row mb-2">
                                    <div class="col fw-bold">知识点</div>
                                    <div class="col-3 fw-bold">权重</div>
                                </div>
                                ${knowledgePointsHtml}
                            </div>
                        </div>

                        <!-- 隐藏字段 -->
                        <input type="hidden" id="edit_knowledge_points" name="knowledge_points" value="">
                    </div>
                </div>
            </form>
        </div>
    `;

    // 显示保存按钮
    const saveBtn = document.getElementById('save-edit-btn');
    if (saveBtn) {
        saveBtn.style.display = 'block';
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>保存更改';
    }

    // 初始化表单交互
    initEditFormEvents();
}
// 删除习题
function deleteExercise() {
    if (!currentExerciseId) return;

    if (confirm('确定要删除这个习题吗？此操作不可恢复。')) {
        // 这里可以添加删除逻辑
        fetch(`/learning/exercise-management/delete/${currentExerciseId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded',
            }
        })
        .then(response => {
            if (response.ok) {
                alert('删除成功！');
                location.reload();
            } else {
                alert('删除失败，请重试。');
            }
        })
        .catch(error => {
            console.error('删除错误:', error);
            alert('删除失败，请重试。');
        });
    }
}
</script>



<!-- 原有JavaScript代码保持不变 -->
<script>
$(document).ready(function() {
    // 初始化工具提示
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });

    // 全选/取消全选
    $('#selectAll').change(function() {
        const isChecked = $(this).prop('checked');
        $('.exercise-checkbox').prop('checked', isChecked);
        updateBatchDeleteButton();
    });

    // 单个复选框改变事件
    $(document).on('change', '.exercise-checkbox', function() {
        const allChecked = $('.exercise-checkbox').length === $('.exercise-checkbox:checked').length;
        $('#selectAll').prop('checked', allChecked);
        updateBatchDeleteButton();
    });

    // 更新批量删除按钮状态
    function updateBatchDeleteButton() {
        const checkedCount = $('.exercise-checkbox:checked').length;
        const btn = $('#batchDeleteBtn');

        if (checkedCount > 0) {
            btn.prop('disabled', false);
            btn.html(`<i class="fas fa-trash-alt"></i> 批量删除 (${checkedCount})`);
        } else {
            btn.prop('disabled', true);
            btn.html(`<i class="fas fa-trash-alt"></i> 批量删除`);
        }
    }

    // 批量删除
    $('#batchDeleteBtn').click(function() {
        const selectedIds = [];
        $('.exercise-checkbox:checked').each(function() {
            selectedIds.push($(this).val());
        });

        if (selectedIds.length > 0) {
            if (confirm(`确定要删除选中的 ${selectedIds.length} 个习题吗？此操作不可恢复。`)) {
                // 显示加载状态
                const originalHtml = $(this).html();
                $(this).html('<i class="fas fa-spinner fa-spin"></i> 删除中...');
                $(this).prop('disabled', true);

                // 发送批量删除请求
                $.ajax({
                    url: "{% url 'exercise_batch_delete' %}",
                    type: 'POST',
                    data: {
                        'exercise_ids': selectedIds,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function(response) {
                        if (response.success) {
                            alert('成功删除 ' + response.deleted_count + ' 个习题！');
                            location.reload();
                        } else {
                            alert('删除失败：' + response.message);
                            $('#batchDeleteBtn').html(originalHtml).prop('disabled', false);
                        }
                    },
                    error: function(xhr, status, error) {
                        alert('请求失败，请重试！');
                        $('#batchDeleteBtn').html(originalHtml).prop('disabled', false);
                        console.error('删除错误:', error);
                    }
                });
            }
        }
    });

    // 单个删除
    $(document).on('click', '.delete-exercise', function() {
        const exerciseId = $(this).data('id');
        const exerciseTitle = $(this).data('title');

        $('#exerciseTitle').text(exerciseTitle);
        $('#deleteForm').attr('action', `/teacher/exercise-management/delete/${exerciseId}/`);

        $('#deleteModal').modal('show');
    });

    // 重置筛选条件
    $('#resetFilters').click(function() {
        window.location.href = "{% url 'exercise_management' %}";
    });

    // 清除筛选条件（空状态时）
    $('#clearFilters').click(function() {
        window.location.href = "{% url 'exercise_management' %}";
    });

    // 导出按钮动态更新URL
    $('#filterForm').on('submit', function() {
        const formData = $(this).serialize();
        $('#exportBtn').attr('href', "{% url 'export_exercises' %}?" + formData);
    });

    // 当筛选条件改变时更新导出URL
    $('#subjectFilter, #typeFilter, #knowledgeFilter, #creatorFilter, #searchInput, #startDate, #endDate').on('change keyup', function() {
        const formData = $('#filterForm').serialize();
        $('#exportBtn').attr('href', "{% url 'export_exercises' %}?" + formData);
    });
});

</script>


<style>
.table th {
    font-weight: 600;
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
}

.table td {
    vertical-align: middle;
}

.badge {
    font-size: 0.75em;
    padding: 0.35em 0.65em;
}

.btn-group .btn {
    border-radius: 4px !important;
}

.form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.table-hover tbody tr:hover {
    background-color: rgba(13, 110, 253, 0.05);
}

.page-link {
    color: #0d6efd;
}

.page-item.active .page-link {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

/* 习题标题链接样式 */
.exercise-detail-link {
    color: #0d6efd;
    cursor: pointer;
    text-decoration: none;
}

.exercise-detail-link:hover {
    color: #0a58ca;
    text-decoration: underline;
}
</style>
{% endblock %}