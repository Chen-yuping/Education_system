<!-- D:\Project\Learning platform\Github\Education_system\learning\templates\teacher\exercise_management.html -->
{% extends 'teacher/base.html' %}


{% block title %}题库管理{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面标题和操作按钮 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">题库管理</h1>
            <p class="text-muted mb-0">管理所有习题，支持增删改查、批量操作</p>
        </div>
        <div>
            <button type="button" class="btn btn-danger mr-2" id="batchDeleteBtn" disabled>
                <i class="fas fa-trash-alt"></i> 批量删除
            </button>
            <a href="{% url 'export_exercises' %}?{{ request.GET.urlencode }}" class="btn btn-success mr-2" id="exportBtn">
                <i class="fas fa-download"></i> 导出习题
            </a>
            <a href="{% url 'exercise_add' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> 添加习题
            </a>
        </div>
    </div>

    <!-- 筛选和搜索区域 -->
    <div class="card shadow mb-4">
        <div class="card-body">
            <form id="filterForm" method="get" class="row g-3">
                <div class="col-md-3">
                    <label for="subjectFilter" class="form-label">科目</label>
                    <select class="form-select" id="subjectFilter" name="subject">
                        <option value="">全部科目</option>
                        {% for subject in subjects %}
                        <option value="{{ subject.id }}" {% if request.GET.subject == subject.id|stringformat:'s' %}selected{% endif %}>
                            {{ subject.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-3">
                    <label for="typeFilter" class="form-label">题型</label>
                    <select class="form-select" id="typeFilter" name="question_type">
                        <option value="">全部题型</option>
                        <option value="single" {% if request.GET.question_type == 'single' %}selected{% endif %}>单选题</option>
                        <option value="multiple" {% if request.GET.question_type == 'multiple' %}selected{% endif %}>多选题</option>
                        <option value="judgment" {% if request.GET.question_type == 'judgment' %}selected{% endif %}>判断题</option>
                        <option value="text" {% if request.GET.question_type == 'text' %}selected{% endif %}>文本题</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label for="knowledgeFilter" class="form-label">知识点</label>
                    <select class="form-select" id="knowledgeFilter" name="knowledge_point">
                        <option value="">全部知识点</option>
                        {% for knowledge in knowledge_points %}
                        <option value="{{ knowledge.id }}" {% if request.GET.knowledge_point == knowledge.id|stringformat:'s' %}selected{% endif %}>
                            {{ knowledge.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-3">
                    <label for="creatorFilter" class="form-label">创建者</label>
                    <select class="form-select" id="creatorFilter" name="creator">
                        <option value="">全部创建者</option>
                        {% for creator in creators %}
                        <option value="{{ creator.id }}" {% if request.GET.creator == creator.id|stringformat:'s' %}selected{% endif %}>
                            {{ creator.username }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-6">
                    <label for="searchInput" class="form-label">搜索</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="searchInput" name="search"
                               placeholder="搜索习题标题或内容" value="{{ request.GET.search|default:'' }}">
                        <button class="btn btn-outline-primary" type="submit">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>

                <div class="col-md-6">
                    <label class="form-label">创建时间</label>
                    <div class="row g-2">
                        <div class="col">
                            <input type="date" class="form-control" id="startDate" name="start_date"
                                   value="{{ request.GET.start_date|default:'' }}">
                        </div>
                        <div class="col-auto d-flex align-items-center">至</div>
                        <div class="col">
                            <input type="date" class="form-control" id="endDate" name="end_date"
                                   value="{{ request.GET.end_date|default:'' }}">
                        </div>
                    </div>
                </div>

                <div class="col-md-12 d-flex justify-content-end">
                    <button type="button" class="btn btn-outline-secondary me-2" id="resetFilters">
                        <i class="fas fa-redo"></i> 重置筛选
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-filter"></i> 筛选
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 习题列表表格 -->
    <div class="card shadow">
        <div class="card-body">
            {% if exercises %}
            <div class="table-responsive">
                <table class="table table-hover" id="exerciseTable">
                    <thead>
                        <tr>
                            <th width="50">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="selectAll">
                                </div>
                            </th>
                            <th>ID</th>
                            <th>习题标题</th>
                            <th>科目</th>
                            <th>题型</th>
                            <th>创建者</th>
                            <th>创建时间</th>
                            <th>关联知识点</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for exercise in exercises %}
                        <tr>
                            <td>
                                <div class="form-check">
                                    <input class="form-check-input exercise-checkbox" type="checkbox"
                                           value="{{ exercise.id }}">
                                </div>
                            </td>
                            <td>{{ exercise.id }}</td>
                            <td>
                                <a href="{% url 'exercise_detail' exercise.id %}"
                                   class="text-decoration-none" title="查看详情"
                                   data-bs-toggle="tooltip" data-bs-placement="top">
                                    {{ exercise.title|truncatechars:30 }}
                                </a>
                                {% if exercise.content|length > 50 %}
                                <br><small class="text-muted">{{ exercise.content|truncatechars:50 }}</small>
                                {% endif %}
                            </td>
                            <td>{{ exercise.subject.name }}</td>
                            <td>
                                {% if exercise.question_type == 'single' %}
                                <span class="badge bg-primary">单选题</span>
                                {% elif exercise.question_type == 'multiple' %}
                                <span class="badge bg-success">多选题</span>
                                {% elif exercise.question_type == 'judgment' %}
                                <span class="badge bg-warning">判断题</span>
                                {% elif exercise.question_type == 'text' %}
                                <span class="badge bg-info">文本题</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ exercise.question_type }}</span>
                                {% endif %}
                            </td>
                            <td>{{ exercise.creator.username|default:"-" }}</td>
                            <td>{{ exercise.created_at|date:"Y-m-d H:i"|default:"-" }}</td>
                            <td>
                                {% with knowledge_points=exercise.qmatrix_set.all %}
                                {% if knowledge_points %}
                                    <div class="d-flex flex-wrap gap-1" style="max-width: 150px;">
                                    {% for qmatrix in knowledge_points|slice:":3" %}
                                        <span class="badge bg-light text-dark"
                                              data-bs-toggle="tooltip"
                                              title="{{ qmatrix.knowledge_point.name }}">
                                            {{ qmatrix.knowledge_point.name|truncatechars:10 }}
                                        </span>
                                    {% endfor %}
                                    {% if knowledge_points.count > 3 %}
                                        <span class="badge bg-secondary"
                                              data-bs-toggle="tooltip"
                                              title="还有{{ knowledge_points.count|add:'-3' }}个知识点">
                                            +{{ knowledge_points.count|add:"-3" }}
                                        </span>
                                    {% endif %}
                                    </div>
                                {% else %}
                                    <span class="text-muted">未关联</span>
                                {% endif %}
                                {% endwith %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="{% url 'exercise_detail' exercise.id %}"
                                       class="btn btn-outline-info"
                                       data-bs-toggle="tooltip"
                                       title="查看详情">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{% url 'exercise_edit' exercise.id %}"
                                       class="btn btn-outline-warning"
                                       data-bs-toggle="tooltip"
                                       title="编辑">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button type="button"
                                            class="btn btn-outline-danger delete-exercise"
                                            data-id="{{ exercise.id }}"
                                            data-title="{{ exercise.title }}"
                                            data-bs-toggle="tooltip"
                                            title="删除">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- 分页 -->
            {% if exercises.has_other_pages %}
            <nav aria-label="Page navigation" class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if exercises.has_previous %}
                    <li class="page-item">
                        <a class="page-link"
                           href="?page={{ exercises.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                    {% endif %}

                    {% for num in exercises.paginator.page_range %}
                        {% if num >= exercises.number|add:"-2" and num <= exercises.number|add:"2" %}
                            {% if exercises.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                            {% else %}
                            <li class="page-item">
                                <a class="page-link"
                                   href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                    {{ num }}
                                </a>
                            </li>
                            {% endif %}
                        {% endif %}
                    {% endfor %}

                    {% if exercises.has_next %}
                    <li class="page-item">
                        <a class="page-link"
                           href="?page={{ exercises.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
                <p class="text-center text-muted mt-2">
                    第 {{ exercises.number }} 页，共 {{ exercises.paginator.num_pages }} 页，
                    总共 {{ exercises.paginator.count }} 条记录
                </p>
            </nav>
            {% endif %}

            {% else %}
            <!-- 空状态 -->
            <div class="text-center py-5">
                <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
                <h5 class="text-muted">暂无习题数据</h5>
                <p class="text-muted mb-4">您还没有添加任何习题，或者筛选条件没有匹配到任何结果</p>
                <a href="{% url 'exercise_add' %}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>添加习题
                </a>
                <button type="button" class="btn btn-outline-secondary ms-2" id="clearFilters">
                    <i class="fas fa-redo me-2"></i>清除筛选条件
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 删除确认模态框 -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">确认删除</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>确定要删除习题 "<span id="exerciseTitle" class="fw-bold"></span>" 吗？</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    此操作将永久删除该习题及其所有相关数据，包括：
                    <ul class="mb-0 mt-2">
                        <li>习题基本信息</li>
                        <li>所有选项</li>
                        <li>Q矩阵关联关系</li>
                        <li>学生的答题记录</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <form id="deleteForm" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">确认删除</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // 初始化工具提示
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });

    // 全选/取消全选
    $('#selectAll').change(function() {
        const isChecked = $(this).prop('checked');
        $('.exercise-checkbox').prop('checked', isChecked);
        updateBatchDeleteButton();
    });

    // 单个复选框改变事件
    $(document).on('change', '.exercise-checkbox', function() {
        const allChecked = $('.exercise-checkbox').length === $('.exercise-checkbox:checked').length;
        $('#selectAll').prop('checked', allChecked);
        updateBatchDeleteButton();
    });

    // 更新批量删除按钮状态
    function updateBatchDeleteButton() {
        const checkedCount = $('.exercise-checkbox:checked').length;
        const btn = $('#batchDeleteBtn');

        if (checkedCount > 0) {
            btn.prop('disabled', false);
            btn.html(`<i class="fas fa-trash-alt"></i> 批量删除 (${checkedCount})`);
        } else {
            btn.prop('disabled', true);
            btn.html(`<i class="fas fa-trash-alt"></i> 批量删除`);
        }
    }

    // 批量删除
    $('#batchDeleteBtn').click(function() {
        const selectedIds = [];
        $('.exercise-checkbox:checked').each(function() {
            selectedIds.push($(this).val());
        });

        if (selectedIds.length > 0) {
            if (confirm(`确定要删除选中的 ${selectedIds.length} 个习题吗？此操作不可恢复。`)) {
                // 显示加载状态
                const originalHtml = $(this).html();
                $(this).html('<i class="fas fa-spinner fa-spin"></i> 删除中...');
                $(this).prop('disabled', true);

                // 发送批量删除请求
                $.ajax({
                    url: "{% url 'exercise_batch_delete' %}",
                    type: 'POST',
                    data: {
                        'exercise_ids': selectedIds,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function(response) {
                        if (response.success) {
                            alert('成功删除 ' + response.deleted_count + ' 个习题！');
                            location.reload();
                        } else {
                            alert('删除失败：' + response.message);
                            $('#batchDeleteBtn').html(originalHtml).prop('disabled', false);
                        }
                    },
                    error: function(xhr, status, error) {
                        alert('请求失败，请重试！');
                        $('#batchDeleteBtn').html(originalHtml).prop('disabled', false);
                        console.error('删除错误:', error);
                    }
                });
            }
        }
    });

    // 单个删除
    $(document).on('click', '.delete-exercise', function() {
        const exerciseId = $(this).data('id');
        const exerciseTitle = $(this).data('title');

        $('#exerciseTitle').text(exerciseTitle);
        $('#deleteForm').attr('action', `/teacher/exercise-management/delete/${exerciseId}/`);

        $('#deleteModal').modal('show');
    });

    // 重置筛选条件
    $('#resetFilters').click(function() {
        window.location.href = "{% url 'exercise_management' %}";
    });

    // 清除筛选条件（空状态时）
    $('#clearFilters').click(function() {
        window.location.href = "{% url 'exercise_management' %}";
    });

    // 导出按钮动态更新URL
    $('#filterForm').on('submit', function() {
        const formData = $(this).serialize();
        $('#exportBtn').attr('href', "{% url 'export_exercises' %}?" + formData);
    });

    // 当筛选条件改变时更新导出URL
    $('#subjectFilter, #typeFilter, #knowledgeFilter, #creatorFilter, #searchInput, #startDate, #endDate').on('change keyup', function() {
        const formData = $('#filterForm').serialize();
        $('#exportBtn').attr('href', "{% url 'export_exercises' %}?" + formData);
    });
});
</script>
<style>
.table th {
    font-weight: 600;
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
}

.table td {
    vertical-align: middle;
}

.badge {
    font-size: 0.75em;
    padding: 0.35em 0.65em;
}

.btn-group .btn {
    border-radius: 4px !important;
}

.form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.table-hover tbody tr:hover {
    background-color: rgba(13, 110, 253, 0.05);
}

.page-link {
    color: #0d6efd;
}

.page-item.active .page-link {
    background-color: #0d6efd;
    border-color: #0d6efd;
}
</style>
{% endblock %}



