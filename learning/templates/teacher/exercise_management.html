<!-- D:\Project\Learning platform\Github\Education_system\learning\templates\teacher\exercise_management.html -->
{% extends 'teacher/course_management_base.html' %}
{% load static %}

{% block title %}题库管理{% endblock %}

{% block content %}

{% if no_subjects %}
<div class="alert alert-warning" role="alert">
    <h4 class="alert-heading">您还没有分配授课科目</h4>
    <p>您目前没有分配任何授课科目，无法查看和管理习题。</p>
    <hr>
    <p class="mb-0">
        <a href="{% url 'teacher_subjects' %}" class="btn btn-primary">
            去分配授课科目
        </a>
    </p>
</div>
{% else %}

<!--主要模块-->
<div class="container-fluid">
    <!-- 筛选和搜索区域 -->
    <div class="card shadow mb-4">
        <div class="card-body">
            <form id="filterForm" method="get" class="row g-3">
                <div class="col-md-3">
                    <label for="typeFilter" class="form-label">题型</label>
                    <select class="form-select" id="typeFilter" name="question_type">
                        <option value="">全部题型</option>
                        <option value="1" {% if request.GET.question_type == '1' %}selected{% endif %}>单选题</option>
                        <option value="2" {% if request.GET.question_type == '2' %}selected{% endif %}>多选题</option>
                        <option value="3" {% if request.GET.question_type == '3' %}selected{% endif %}>投票题</option>
                        <option value="4" {% if request.GET.question_type == '4' %}selected{% endif %}>填空题</option>
                        <option value="5" {% if request.GET.question_type == '5' %}selected{% endif %}>主观题</option>
                        <option value="6" {% if request.GET.question_type == '6' %}selected{% endif %}>判断题</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label for="knowledgeFilter" class="form-label">知识点</label>
                    <select class="form-select" id="knowledgeFilter" name="knowledge_point">
                        <option value="">全部知识点</option>
                        {% for knowledge in knowledge_points %}
                        <option value="{{ knowledge.id }}" {% if request.GET.knowledge_point == knowledge.id|stringformat:'s' %}selected{% endif %}>
                            {{ knowledge.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-6">
                    <label for="searchInput" class="form-label">搜索</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="searchInput" name="search"
                               placeholder="搜索习题标题或内容" value="{{ request.GET.search|default:'' }}">
                        <button class="btn btn-outline-primary" type="submit">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>

                <div class="col-md-12 d-flex justify-content-end">
                    <button type="button" class="btn btn-outline-secondary me-2" id="resetFilters">
                        <i class="fas fa-redo"></i> 重置筛选
                    </button>
                    <button type="button" class="btn btn-primary" onclick="showAddExercise()">
                        <i class="fas fa-plus"></i> 添加习题
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 习题列表表格 -->
    <div class="card shadow">
        <div class="card-body">
            {% if exercises %}
            <div class="table-responsive">
                <table class="table table-hover" id="exerciseTable">
                    <thead>
                        <tr>
                            <th width="50">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="selectAll">
                                </div>
                            </th>
                            <th>ID</th>
                            <th>习题标题</th>
                            <th>科目</th>
                            <th>题型</th>
                            <th>创建者</th>
                            <th>关联知识点</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for exercise in exercises %}
                        <tr>
                            <td>
                                <div class="form-check">
                                    <input class="form-check-input exercise-checkbox" type="checkbox"
                                           value="{{ exercise.id }}">
                                </div>
                            </td>
                            <td>{{ exercise.id }}</td>
                            <td>
                                <a href="javascript:void(0);"
                                   onclick="showExerciseDetail({{ exercise.id }})"
                                   class="text-decoration-none exercise-detail-link"
                                   title="点击查看详情"
                                   data-bs-toggle="tooltip" data-bs-placement="top">
                                    {{ exercise.title|truncatechars:30 }}
                                </a>

                                <br><small class="text-muted">{{ exercise.content|truncatechars:50 }}</small>

                            </td>
                            <td>{{ exercise.subject.name }}</td>
                            <td>
                                {% if exercise.question_type == '1' %}
                                <span class="badge bg-primary">单选题</span>
                                {% elif exercise.question_type == '2' %}
                                <span class="badge bg-success">多选题</span>
                                {% elif exercise.question_type == '3' %}
                                <span class="badge bg-warning">投票题</span>
                                {% elif exercise.question_type == '4' %}
                                <span class="badge bg-info">填空题</span>
                                {% elif exercise.question_type == '5' %}
                                <span class="badge bg-warning">主观题</span>
                                {% elif exercise.question_type == '6' %}
                                <span class="badge bg-info">判断题</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ exercise.question_type }}</span>
                                {% endif %}
                            </td>
                            <td>{{ exercise.creator.username|default:"-" }}</td>
                            <td>
                                {% with knowledge_points=exercise.qmatrix_set.all %}
                                {% if knowledge_points %}
                                    <div class="d-flex flex-wrap gap-1" style="max-width: 150px;">
                                    {% for qmatrix in knowledge_points|slice:":3" %}
                                        <span class="badge bg-light text-dark"
                                              data-bs-toggle="tooltip"
                                              title="{{ qmatrix.knowledge_point.name }}">
                                            {{ qmatrix.knowledge_point.name|truncatechars:10 }}
                                        </span>
                                    {% endfor %}
                                    {% if knowledge_points.count > 3 %}
                                        <span class="badge bg-secondary"
                                              data-bs-toggle="tooltip"
                                              title="还有{{ knowledge_points.count|add:'-3' }}个知识点">
                                            +{{ knowledge_points.count|add:"-3" }}
                                        </span>
                                    {% endif %}
                                    </div>
                                {% else %}
                                    <span class="text-muted">未关联</span>
                                {% endif %}
                                {% endwith %}
                            </td>
                            <td>
                                <div class="d-flex gap-2">
                                    <a href="javascript:void(0);"
                                       onclick="showExerciseDetail({{ exercise.id }})"
                                       class="btn btn-sm btn-outline-info"
                                       data-bs-toggle="tooltip"
                                       title="查看详情">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="javascript:void(0);"
                                       onclick="showExerciseEdit({{ exercise.id }})"
                                       class="btn btn-sm btn-outline-warning"
                                       data-bs-toggle="tooltip"
                                       title="编辑">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <a href="javascript:void(0);"
                                       onclick="deleteExercise({{ exercise.id }})"
                                       class="btn btn-sm btn-outline-danger"
                                       data-bs-toggle="tooltip"
                                       title="删除">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- 分页 -->
            {% if exercises.has_other_pages %}
            <nav aria-label="Page navigation" class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if exercises.has_previous %}
                    <li class="page-item">
                        <a class="page-link"
                           href="?page={{ exercises.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                    {% endif %}

                    {% for num in exercises.paginator.page_range %}
                        {% if num >= exercises.number|add:"-2" and num <= exercises.number|add:"2" %}
                            {% if exercises.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                            {% else %}
                            <li class="page-item">
                                <a class="page-link"
                                   href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                    {{ num }}
                                </a>
                            </li>
                            {% endif %}
                        {% endif %}
                    {% endfor %}

                    {% if exercises.has_next %}
                    <li class="page-item">
                        <a class="page-link"
                           href="?page={{ exercises.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
                <p class="text-center text-muted mt-2">
                    第 {{ exercises.number }} 页，共 {{ exercises.paginator.num_pages }} 页，
                    总共 {{ exercises.paginator.count }} 条记录
                </p>
            </nav>
            {% endif %}

            {% else %}
            <!-- 空状态 -->
            <div class="text-center py-5">
                <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
                <h5 class="text-muted">暂无习题数据</h5>
                <p class="text-muted mb-4">您还没有添加任何习题，或者筛选条件没有匹配到任何结果</p>
                <a href="{% url 'exercise_add' %}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>添加习题
                </a>
                <button type="button" class="btn btn-outline-secondary ms-2" id="clearFilters">
                    <i class="fas fa-redo me-2"></i>清除筛选条件
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 删除确认模态框 -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteConfirmModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>删除习题
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0">
                    <i class="fas fa-warning text-danger me-2"></i>
                    <strong>确定要删除这道习题吗？</strong>
                </p>
                <p class="text-muted mt-2 mb-0">删除后无法恢复，请谨慎操作。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>取消
                </button>
                <button type="button" class="btn btn-danger" id="deleteConfirmBtn">
                    <i class="fas fa-trash me-1"></i>确认删除
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 习题详情模态框 -->
<div class="modal fade" id="exerciseDetailModal" tabindex="-1" aria-labelledby="exerciseDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="exerciseDetailModalLabel">
                    <i class="fas fa-question-circle me-2"></i>习题详情
                    <span id="exercise-id-badge" class="badge bg-light text-dark ms-2"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="exercise-detail-content">
                <!-- 内容将通过JavaScript动态加载 -->
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <p class="mt-2">正在加载习题详情...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-warning" onclick="openEditFromDetail()">
                    <i class="fas fa-edit me-1"></i>编辑
                </button>
            </div>
        </div>
    </div>
</div>
<!-- 习题编辑模态框 -->
<div class="modal fade" id="exerciseEditModal" tabindex="-1" aria-labelledby="exerciseEditModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content" style="max-height: 90vh;">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="exerciseEditModalLabel">
                    <i class="fas fa-edit me-2"></i>编辑习题
                    <span id="edit-exercise-id-badge" class="badge bg-light text-dark ms-2"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="exerciseEditModalBody" style="overflow-y: auto; max-height: calc(90vh - 130px);">
                <!-- 内容将通过JavaScript动态加载 -->
                <div class="text-center py-5">
                    <div class="spinner-border text-warning" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <p class="mt-2">正在加载编辑表单...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-warning" id="save-edit-btn">
                    <i class="fas fa-save me-1"></i>保存更改
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 添加习题模态框 -->
<div class="modal fade" id="exerciseAddModal" tabindex="-1" aria-labelledby="exerciseAddModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content" style="max-height: 90vh;">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="exerciseAddModalLabel">
                    <i class="fas fa-plus me-2"></i>添加习题
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="exerciseAddModalBody" style="overflow-y: auto; max-height: calc(90vh - 130px);">
                <div class="row">
                    <div class="col-md-6">
                        <!-- 科目 -->
                        <div class="mb-3">
                            <label for="add_subject" class="form-label fw-bold">所属科目 *</label>
                            <select class="form-select" id="add_subject" name="subject_id" required>
                                {% for subject in subjects %}
                                <option value="{{ subject.id }}">{{ subject.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- 标题 -->
                        <div class="mb-3">
                            <label for="add_title" class="form-label fw-bold">习题标题 *</label>
                            <input type="text" class="form-control" id="add_title" name="title" required placeholder="输入习题标题">
                        </div>

                        <!-- 题型 -->
                        <div class="mb-3">
                            <label for="add_question_type" class="form-label fw-bold">题型 *</label>
                            <select class="form-select" id="add_question_type" name="question_type" required>
                                <option value="single">单选题</option>
                                <option value="multiple">多选题</option>
                                <option value="judgment">判断题</option>
                                <option value="fill">填空题</option>
                                <option value="subjective">主观题</option>
                            </select>
                        </div>

                        <!-- 答案 -->
                        <div class="mb-3">
                            <label for="add_answer" class="form-label fw-bold">参考答案 *</label>
                            <input type="text" class="form-control" id="add_answer" name="answer" required placeholder="输入参考答案，如：A 或 A,B,C">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <!-- 内容 -->
                        <div class="mb-3">
                            <label for="add_content" class="form-label fw-bold">习题内容 *</label>
                            <textarea class="form-control" id="add_content" name="content" rows="4" required placeholder="输入习题内容"></textarea>
                        </div>

                        <!-- 选项 -->
                        <div class="mb-3" id="add_options_section">
                            <label class="form-label fw-bold">选项内容</label>
                            <div id="add_choices_container">
                                <div class="input-group mb-2">
                                    <span class="input-group-text">A</span>
                                    <input type="text" class="form-control add-choice-input" placeholder="选项A内容">
                                    <div class="input-group-text">
                                        <input type="checkbox" class="form-check-input add-choice-correct" title="设为正确答案">
                                    </div>
                                </div>
                                <div class="input-group mb-2">
                                    <span class="input-group-text">B</span>
                                    <input type="text" class="form-control add-choice-input" placeholder="选项B内容">
                                    <div class="input-group-text">
                                        <input type="checkbox" class="form-check-input add-choice-correct" title="设为正确答案">
                                    </div>
                                </div>
                                <div class="input-group mb-2">
                                    <span class="input-group-text">C</span>
                                    <input type="text" class="form-control add-choice-input" placeholder="选项C内容">
                                    <div class="input-group-text">
                                        <input type="checkbox" class="form-check-input add-choice-correct" title="设为正确答案">
                                    </div>
                                </div>
                                <div class="input-group mb-2">
                                    <span class="input-group-text">D</span>
                                    <input type="text" class="form-control add-choice-input" placeholder="选项D内容">
                                    <div class="input-group-text">
                                        <input type="checkbox" class="form-check-input add-choice-correct" title="设为正确答案">
                                    </div>
                                </div>
                            </div>
                            <div class="form-text">勾选复选框表示正确答案</div>
                        </div>
                    </div>
                </div>

                <!-- 答案解析 -->
                <div class="mb-3">
                    <label for="add_solution" class="form-label fw-bold">答案解析</label>
                    <textarea class="form-control" id="add_solution" name="solution" rows="2" placeholder="输入答案解析（可选）"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="save-add-btn" onclick="submitAddExercise()">
                    <i class="fas fa-save me-1"></i>保存习题
                </button>
            </div>
        </div>
    </div>
</div>


{% endif %}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
// 全局变量，存储当前选中的习题ID
let currentExerciseId = null;

// 显示添加习题模态框
function showAddExercise() {
    // 清空表单
    document.getElementById('add_title').value = '';
    document.getElementById('add_content').value = '';
    document.getElementById('add_answer').value = '';
    document.getElementById('add_solution').value = '';
    
    // 清空选项
    document.querySelectorAll('.add-choice-input').forEach(input => input.value = '');
    document.querySelectorAll('.add-choice-correct').forEach(checkbox => checkbox.checked = false);
    
    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('exerciseAddModal'));
    modal.show();
}

// 提交添加习题
function submitAddExercise() {
    const saveBtn = document.getElementById('save-add-btn');
    
    // 验证必填字段
    const title = document.getElementById('add_title').value.trim();
    const content = document.getElementById('add_content').value.trim();
    const answer = document.getElementById('add_answer').value.trim();
    const subjectId = document.getElementById('add_subject').value;
    const questionType = document.getElementById('add_question_type').value;
    
    if (!title) {
        alert('请输入习题标题');
        return;
    }
    if (!content) {
        alert('请输入习题内容');
        return;
    }
    if (!answer) {
        alert('请输入参考答案');
        return;
    }
    
    // 收集选项数据
    const choices = [];
    document.querySelectorAll('.add-choice-input').forEach((input, index) => {
        const choiceContent = input.value.trim();
        const isCorrect = document.querySelectorAll('.add-choice-correct')[index].checked;
        if (choiceContent) {
            choices.push({
                content: choiceContent,
                is_correct: isCorrect,
                order: index
            });
        }
    });
    
    // 构建表单数据
    const formData = new FormData();
    formData.append('subject_id', subjectId);
    formData.append('title', title);
    formData.append('content', content);
    formData.append('question_type', questionType);
    formData.append('answer', answer);
    formData.append('solution', document.getElementById('add_solution').value);
    formData.append('choices', JSON.stringify(choices));
    
    // 显示加载状态
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>保存中...';
    
    // 发送请求
    fetch('/learning/exercise-management/add-json/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('习题添加成功！');
            const modal = bootstrap.Modal.getInstance(document.getElementById('exerciseAddModal'));
            if (modal) modal.hide();
            location.reload();
        } else {
            alert('添加失败：' + (data.message || '未知错误'));
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>保存习题';
        }
    })
    .catch(error => {
        console.error('添加习题失败:', error);
        alert('网络错误，请重试。');
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>保存习题';
    });
}

// 显示习题详情模态框
function showExerciseDetail(exerciseId) {
    currentExerciseId = exerciseId;

    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('exerciseDetailModal'));
    modal.show();

    // 加载习题详情数据
    loadExerciseDetail(exerciseId);
}

// 加载习题详情
function loadExerciseDetail(exerciseId) {
    const contentDiv = document.getElementById('exercise-detail-content');

    // 显示加载中
    contentDiv.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
            <p class="mt-2">正在加载习题详情...</p>
        </div>
    `;

    // 发送AJAX请求获取习题详情
    fetch(`/learning/exercise-management/detail/${exerciseId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderExerciseDetail(data.exercise);
            } else {
                contentDiv.innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        <h5 class="alert-heading">加载失败</h5>
                        <p>${data.message || '无法加载习题详情'}</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('加载习题详情失败:', error);
            contentDiv.innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <h5 class="alert-heading">加载失败</h5>
                    <p>网络错误，请稍后重试。</p>
                </div>
            `;
        });
}

// 渲染习题详情
function renderExerciseDetail(exercise) {
    const contentDiv = document.getElementById('exercise-detail-content');
    const idBadge = document.getElementById('exercise-id-badge');

    // 更新ID徽章
    idBadge.textContent = `ID: ${exercise.id}`;

    // 生成知识点标签HTML
    let knowledgePointsHtml = '';
    if (exercise.knowledge_points && exercise.knowledge_points.length > 0) {
        exercise.knowledge_points.forEach(kp => {
            knowledgePointsHtml += `
                <span class="badge bg-primary me-1 mb-1">
                    ${kp.knowledge_point__name || kp.name || '未命名'}
                    ${kp.weight ? `<span class="badge bg-light text-dark ms-1">${kp.weight}</span>` : ''}
                </span>
            `;
        });
    } else {
        knowledgePointsHtml = '<p class="text-muted">未关联知识点</p>';
    }

    // 生成HTML内容
    contentDiv.innerHTML = `
        <!-- 基本信息 -->
        <div class="mb-4">
            <h4>${exercise.title || '无标题'}</h4>
            <div class="mb-2">
                <span class="badge bg-info text-dark me-1">${exercise.subject || '未分类'}</span>
                <span class="badge bg-secondary me-1">${exercise.question_type || '未知题型'}</span>

            </div>
        </div>

        <!-- 习题内容 -->
        <div class="mb-4">
            <h6><i class="fas fa-text-paragraph me-1"></i> 习题内容：</h6>
            <div class="border rounded p-3 bg-light">
    <!-- 显示题目内容 -->
    ${exercise.content ? exercise.content.replace(/\n/g, '<br>') : '<span class="text-muted">无内容</span>'}

    <!-- 显示选项（如果存在） -->
    ${exercise.option_text ?
        (() => {
            try {
                // 首先尝试直接解析
                const options = JSON.parse(exercise.option_text);
                return formatOptions(options);
            } catch (e1) {
                try {
                    // 如果失败，尝试替换单引号为双引号
                    const fixedStr = exercise.option_text
                        .replace(/'/g, '"')
                        .replace(/(\w+):/g, '"$1":');  // 处理键名
                    const options = JSON.parse(fixedStr);
                    return formatOptions(options);
                } catch (e2) {
                    try {
                        // 如果还是失败，尝试手动解析类似Python字典的格式
                        const str = exercise.option_text.trim();
                        if (str.startsWith('{') && str.endsWith('}')) {
                            const content = str.slice(1, -1);
                            const pairs = content.split(',');
                            const options = {};
                            pairs.forEach(pair => {
                                const [key, value] = pair.split(':').map(s => s.trim());
                                // 移除引号
                                const cleanKey = key.replace(/['"`]/g, '');
                                const cleanValue = value ? value.replace(/['"`]/g, '') : '';
                                options[cleanKey] = cleanValue;
                            });
                            return formatOptions(options);
                        }
                    } catch (e3) {
                        // 所有解析都失败，直接显示原始文本
                        return `<div class="mt-3"><strong>选项：</strong><br>${exercise.option_text.replace(/\n/g, '<br>')}</div>`;
                    }
                }
            }

            // 格式化选项的辅助函数
            function formatOptions(options) {
                if (!options || typeof options !== 'object') {
                    return `<div class="mt-3">${exercise.option_text.replace(/\n/g, '<br>')}</div>`;
                }

                const formattedOptions = Object.entries(options)
                    .sort(([keyA], [keyB]) => keyA.localeCompare(keyB))
                    .map(([key, value]) => `<strong>${key}:</strong> ${value || ''}`)
                    .join('<br>');

                return `<div class="mt-3">${formattedOptions}</div>`;
            }
        })()
        : ''
    }
</div>
        </div>

        <!-- 答案和解析 -->
        <div class="row mb-4">
            <div class="col-md-6">
                <h6><i class="fas fa-check-circle me-1"></i> 参考答案：</h6>
                <div class="border rounded p-3 bg-light">
                    ${exercise.answer ? exercise.answer.replace(/\n/g, '<br>') : '<span class="text-muted">暂无答案</span>'}
                </div>
            </div>
            <div class="col-md-6">
                <h6><i class="fas fa-lightbulb me-1"></i> 答案解析：</h6>
                <div class="border rounded p-3 bg-light">
                    ${exercise.solution ? exercise.solution.replace(/\n/g, '<br>') : '<span class="text-muted">暂无解析</span>'}
                </div>
            </div>
        </div>

        <!-- 知识点 -->
        <div class="mb-4">
            <h6><i class="fas fa-tags me-1"></i> 关联知识点：</h6>
            <div class="d-flex flex-wrap">
                ${knowledgePointsHtml}
            </div>
        </div>


    `;
}
// 全局变量
let currentEditExerciseId = null;
let currentEditExerciseData = null;

// 显示编辑模态框
function showExerciseEdit(exerciseId) {
    currentEditExerciseId = exerciseId;

    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('exerciseEditModal'));
    modal.show();

    // 加载习题数据用于编辑
    loadExerciseForEdit(exerciseId);
}

// 加载习题数据用于编辑
function loadExerciseForEdit(exerciseId) {
    const contentDiv = document.getElementById('exerciseEditModalBody');

    // 显示加载中
    contentDiv.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-warning" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
            <p class="mt-2">正在加载编辑表单...</p>
        </div>
    `;

    // 发送AJAX请求获取习题详情
    fetch(`/learning/exercise-management/detail/${exerciseId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentEditExerciseData = data.exercise;
                renderExerciseEditForm(data.exercise);
            } else {
                contentDiv.innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        <h5 class="alert-heading">加载失败</h5>
                        <p>${data.message || '无法加载习题数据'}</p>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    </div>
                `;
                document.getElementById('save-edit-btn').style.display = 'none';
            }
        })
        .catch(error => {
            console.error('加载习题编辑数据失败:', error);
            contentDiv.innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <h5 class="alert-heading">加载失败</h5>
                    <p>网络错误，请稍后重试。</p>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            `;
            document.getElementById('save-edit-btn').style.display = 'none';
        });
}

// 渲染编辑表单
function renderExerciseEditForm(exercise) {
    const contentDiv = document.getElementById('exerciseEditModalBody');
    const idBadge = document.getElementById('edit-exercise-id-badge');

    // 更新ID徽章
    idBadge.textContent = `ID: ${exercise.id}`;

    // 处理内容，转义特殊字符
    let contentText = exercise.content || '';
    contentText = contentText.replace(/</g, '&lt;').replace(/>/g, '&gt;');

    // 生成选项编辑HTML
    let choicesHtml = '';
    if (exercise.choices && exercise.choices.length > 0) {
        exercise.choices.forEach((choice, index) => {
            const choiceContent = (choice.content || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            const optionLabel = String.fromCharCode(65 + index); // A, B, C, D...
            choicesHtml += `
                <div class="input-group mb-2">
                    <span class="input-group-text">${optionLabel}</span>
                    <input type="text" class="form-control choice-input" 
                           data-choice-id="${choice.id}"
                           value="${choiceContent}">
                    ${choice.is_correct ? '<span class="input-group-text text-success"><i class="fas fa-check"></i></span>' : ''}
                </div>
            `;
        });
    } else {
        choicesHtml = '<p class="text-muted">该题目没有选项</p>';
    }

    // 生成知识点选择HTML - 两列并列设计
    let knowledgePointsHtml = '';
    if (exercise.all_knowledge_points && exercise.all_knowledge_points.length > 0) {
        // 创建已选知识点的映射
        const selectedKnowledgePoints = {};
        if (exercise.knowledge_points) {
            exercise.knowledge_points.forEach(kp => {
                selectedKnowledgePoints[kp.knowledge_point__id] = true;
            });
        }

        // 分离已选和未选的知识点
        const unselectedKPs = exercise.all_knowledge_points.filter(kp => !selectedKnowledgePoints.hasOwnProperty(kp.id));
        const selectedKPs = exercise.all_knowledge_points.filter(kp => selectedKnowledgePoints.hasOwnProperty(kp.id));

        // 生成未选知识点列表
        let unselectedHtml = '';
        unselectedKPs.forEach(kp => {
            unselectedHtml += `
                <div class="list-group-item d-flex justify-content-between align-items-center unselected-kp" data-kp-id="${kp.id}" data-kp-name="${kp.name}">
                    <span>${kp.name}</span>
                    <button type="button" class="btn btn-sm btn-primary add-kp-btn" data-kp-id="${kp.id}" data-kp-name="${kp.name}">
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            `;
        });

        // 生成已选知识点列表
        let selectedHtml = '';
        selectedKPs.forEach(kp => {
            selectedHtml += `
                <div class="list-group-item d-flex justify-content-between align-items-center selected-kp" data-kp-id="${kp.id}">
                    <span>${kp.name}</span>
                    <button type="button" class="btn btn-sm btn-danger remove-kp-btn" data-kp-id="${kp.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        });

        knowledgePointsHtml = `
            <div class="row g-3">
                <!-- 未选择的知识点 -->
                <div class="col-md-6">
                    <div class="border rounded p-3 bg-light h-100">
                        <h6 class="mb-3 fw-bold">未关联知识点</h6>
                        <div class="mb-2">
                            <input type="text" class="form-control form-control-sm" id="kp_search" placeholder="搜索知识点...">
                        </div>
                        <div class="list-group" style="max-height: 300px; overflow-y: auto;" id="unselected-kp-list">
                            ${unselectedHtml || '<div class="list-group-item text-muted text-center py-3">全部知识点已关联</div>'}
                        </div>
                    </div>
                </div>
                <!-- 已选择的知识点 -->
                <div class="col-md-6">
                    <div class="border rounded p-3 bg-light h-100">
                        <h6 class="mb-3 fw-bold">已关联知识点</h6>
                        <div class="list-group" style="max-height: 300px; overflow-y: auto;" id="selected-kp-list">
                            ${selectedHtml || '<div class="list-group-item text-muted text-center py-3">暂无关联知识点</div>'}
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else {
        knowledgePointsHtml = '<p class="text-muted">该科目下暂无知识点</p>';
    }

    // 生成表单HTML
    contentDiv.innerHTML = `
        <div class="row">
            <div class="col-12">
                <!-- 基本信息（只读） -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">所属科目</label>
                        <input type="text" class="form-control" value="${exercise.subject || ''}" readonly disabled>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">习题标题</label>
                        <input type="text" class="form-control" value="${exercise.title || ''}" readonly disabled>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">题型</label>
                    <input type="text" class="form-control" value="${exercise.question_type || ''}" readonly disabled style="max-width: 200px;">
                </div>

                <hr>

                <!-- 题目内容（可编辑） -->
                <div class="mb-3">
                    <label for="edit_content" class="form-label fw-bold">
                        <i class="fas fa-edit text-warning me-1"></i>题目内容
                    </label>
                    <textarea class="form-control" id="edit_content" name="content"
                              rows="4">${contentText}</textarea>
                </div>

                <!-- 选项（可编辑） -->
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        <i class="fas fa-edit text-warning me-1"></i>选项内容
                    </label>
                    <div class="border rounded p-3 bg-light">
                        ${choicesHtml}
                    </div>
                    <div class="form-text">绿色勾号表示正确答案</div>
                </div>

                <!-- 参考答案（可编辑） -->
                <div class="mb-3">
                    <label for="edit_solution" class="form-label fw-bold">
                        <i class="fas fa-edit text-warning me-1"></i>答案解析
                    </label>
                    <textarea class="form-control" id="edit_solution" name="solution"
                              rows="3" placeholder="输入答案解析">${exercise.solution || ''}</textarea>
                </div>

                <!-- 知识点关联（可编辑） -->
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        <i class="fas fa-edit text-warning me-1"></i>关联知识点
                    </label>
                    ${knowledgePointsHtml}
                </div>
            </div>
        </div>
    `;

    // 显示保存按钮
    const saveBtn = document.getElementById('save-edit-btn');
    if (saveBtn) {
        saveBtn.style.display = 'block';
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>保存更改';
    }

    // 初始化表单交互
    initEditFormEvents();
}

// 从详情模态框打开编辑模态框
function openEditFromDetail() {
    if (!currentExerciseId) return;
    // 关闭详情模态框
    const detailModal = bootstrap.Modal.getInstance(document.getElementById('exerciseDetailModal'));
    if (detailModal) detailModal.hide();
    // 打开编辑模态框
    setTimeout(() => showExerciseEdit(currentExerciseId), 300);
}

// 初始化编辑表单事件
function initEditFormEvents() {
    // 知识点搜索功能
    const searchInput = document.getElementById('kp_search');
    if (searchInput) {
        searchInput.addEventListener('keyup', function() {
            const searchTerm = this.value.toLowerCase();
            const unselectedItems = document.querySelectorAll('.unselected-kp');
            unselectedItems.forEach(item => {
                const kpName = item.dataset.kpName.toLowerCase();
                item.style.display = kpName.includes(searchTerm) ? '' : 'none';
            });
        });
    }

    // 添加知识点按钮
    document.querySelectorAll('.add-kp-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const kpId = this.dataset.kpId;
            const kpName = this.dataset.kpName;
            addKnowledgePoint(kpId, kpName);
        });
    });

    // 移除知识点按钮
    document.querySelectorAll('.remove-kp-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const kpId = this.dataset.kpId;
            removeKnowledgePoint(kpId);
        });
    });

    // 表单提交处理
    const saveBtn = document.getElementById('save-edit-btn');
    if (saveBtn) {
        saveBtn.onclick = function(e) {
            e.preventDefault();
            submitEditForm();
        };
    }
}

// 添加知识点到已选列表
function addKnowledgePoint(kpId, kpName) {
    const unselectedList = document.getElementById('unselected-kp-list');
    const selectedList = document.getElementById('selected-kp-list');
    
    // 移除未选列表中的项
    const unselectedItem = document.querySelector(`.unselected-kp[data-kp-id="${kpId}"]`);
    if (unselectedItem) {
        unselectedItem.remove();
    }
    
    // 检查是否为空
    if (unselectedList.querySelectorAll('.unselected-kp').length === 0) {
        unselectedList.innerHTML = '<div class="list-group-item text-muted">全部知识点已关联</div>';
    }
    
    // 添加到已选列表
    const selectedItem = document.createElement('div');
    selectedItem.className = 'list-group-item d-flex justify-content-between align-items-center selected-kp';
    selectedItem.dataset.kpId = kpId;
    selectedItem.innerHTML = `
        <span>${kpName}</span>
        <button type="button" class="btn btn-sm btn-danger remove-kp-btn" data-kp-id="${kpId}">
            <i class="fas fa-trash"></i>
        </button>
    `;
    
    // 清空"暂无关联知识点"提示
    const emptyMsg = selectedList.querySelector('.text-muted');
    if (emptyMsg) {
        emptyMsg.remove();
    }
    
    selectedList.appendChild(selectedItem);
    
    // 绑定移除按钮事件
    selectedItem.querySelector('.remove-kp-btn').addEventListener('click', function(e) {
        e.preventDefault();
        removeKnowledgePoint(kpId);
    });
}

// 从已选列表移除知识点
function removeKnowledgePoint(kpId) {
    const unselectedList = document.getElementById('unselected-kp-list');
    const selectedList = document.getElementById('selected-kp-list');
    
    // 获取知识点名称
    const selectedItem = document.querySelector(`.selected-kp[data-kp-id="${kpId}"]`);
    if (!selectedItem) return;
    
    const kpName = selectedItem.querySelector('span').textContent;
    
    // 移除已选列表中的项
    selectedItem.remove();
    
    // 检查是否为空
    if (selectedList.querySelectorAll('.selected-kp').length === 0) {
        selectedList.innerHTML = '<div class="list-group-item text-muted">暂无关联知识点</div>';
    }
    
    // 添加回未选列表
    const unselectedItem = document.createElement('div');
    unselectedItem.className = 'list-group-item d-flex justify-content-between align-items-center unselected-kp';
    unselectedItem.dataset.kpId = kpId;
    unselectedItem.dataset.kpName = kpName;
    unselectedItem.innerHTML = `
        <span>${kpName}</span>
        <button type="button" class="btn btn-sm btn-primary add-kp-btn" data-kp-id="${kpId}" data-kp-name="${kpName}">
            <i class="fas fa-arrow-right"></i>
        </button>
    `;
    
    // 清空"全部知识点已关联"提示
    const emptyMsg = unselectedList.querySelector('.text-muted');
    if (emptyMsg) {
        emptyMsg.remove();
    }
    
    unselectedList.appendChild(unselectedItem);
    
    // 绑定添加按钮事件
    unselectedItem.querySelector('.add-kp-btn').addEventListener('click', function(e) {
        e.preventDefault();
        addKnowledgePoint(kpId, kpName);
    });
}

// 提交编辑表单
function submitEditForm() {
    const saveBtn = document.getElementById('save-edit-btn');

    // 收集表单数据
    const formData = new FormData();
    formData.append('content', document.getElementById('edit_content').value);

    // 收集选项数据
    const choices = [];
    document.querySelectorAll('.choice-input').forEach(input => {
        const choiceId = input.dataset.choiceId;
        const content = input.value;
        if (choiceId && content) {
            choices.push({ id: parseInt(choiceId), content: content });
        }
    });
    formData.append('choices', JSON.stringify(choices));

    // 收集答案解析
    const solutionInput = document.getElementById('edit_solution');
    if (solutionInput) {
        formData.append('solution', solutionInput.value);
    }

    // 收集知识点数据 - 只收集已选列表中的知识点ID
    const knowledgePoints = [];
    document.querySelectorAll('.selected-kp').forEach(item => {
        const kpId = item.dataset.kpId;
        if (kpId) {
            knowledgePoints.push({ id: parseInt(kpId) });
        }
    });
    formData.append('knowledge_points', JSON.stringify(knowledgePoints));

    // 显示加载状态
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>保存中...';

    // 发送请求
    fetch(`/learning/exercise-management/update/${currentEditExerciseId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('习题更新成功！');
            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('exerciseEditModal'));
            if (modal) modal.hide();
            // 刷新页面
            location.reload();
        } else {
            alert('更新失败：' + (data.message || '未知错误'));
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>保存更改';
        }
    })
    .catch(error => {
        console.error('更新习题失败:', error);
        alert('网络错误，请重试。');
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>保存更改';
    });
}

// 删除习题
function deleteExercise(exerciseId) {
    // 显示删除确认模态框
    const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    document.getElementById('deleteConfirmBtn').dataset.exerciseId = exerciseId;
    modal.show();
}

// 确认删除
document.getElementById('deleteConfirmBtn')?.addEventListener('click', function() {
    const exerciseId = this.dataset.exerciseId;
    
    // 发送删除请求
    fetch(`/learning/exercise-management/delete/${exerciseId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
            if (modal) modal.hide();
            alert('习题删除成功！');
            location.reload();
        } else {
            alert('删除失败：' + (data.message || '未知错误'));
        }
    })
    .catch(error => {
        console.error('删除习题失败:', error);
        alert('网络错误，请重试。');
    });
});
</script>



<!-- 原有JavaScript代码保持不变 -->
<script>
$(document).ready(function() {
    // 初始化工具提示
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });

    // 全选/取消全选
    $('#selectAll').change(function() {
        const isChecked = $(this).prop('checked');
        $('.exercise-checkbox').prop('checked', isChecked);
        updateBatchDeleteButton();
    });

    // 单个复选框改变事件
    $(document).on('change', '.exercise-checkbox', function() {
        const allChecked = $('.exercise-checkbox').length === $('.exercise-checkbox:checked').length;
        $('#selectAll').prop('checked', allChecked);
    });

    // 重置筛选条件
    $('#resetFilters').click(function() {
        window.location.href = "{% url 'exercise_management' %}";
    });

    // 清除筛选条件（空状态时）
    $('#clearFilters').click(function() {
        window.location.href = "{% url 'exercise_management' %}";
    });

    // 导出按钮动态更新URL
    $('#filterForm').on('submit', function() {
        const formData = $(this).serialize();
        $('#exportBtn').attr('href', "{% url 'export_exercises' %}?" + formData);
    });

    // 当筛选条件改变时更新导出URL
    $('#subjectFilter, #typeFilter, #knowledgeFilter, #creatorFilter, #searchInput, #startDate, #endDate').on('change keyup', function() {
        const formData = $('#filterForm').serialize();
        $('#exportBtn').attr('href', "{% url 'export_exercises' %}?" + formData);
    });
});

</script>


<style>
.table th {
    font-weight: 600;
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
}

.table td {
    vertical-align: middle;
}

.badge {
    font-size: 0.75em;
    padding: 0.35em 0.65em;
}

.btn-group .btn {
    border-radius: 4px !important;
}

.form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.table-hover tbody tr:hover {
    background-color: rgba(13, 110, 253, 0.05);
}

.page-link {
    color: #0d6efd;
}

.page-item.active .page-link {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

/* 习题标题链接样式 */
.exercise-detail-link {
    color: #0d6efd;
    cursor: pointer;
    text-decoration: none;
}

.exercise-detail-link:hover {
    color: #0a58ca;
    text-decoration: underline;
}
</style>
{% endblock %}
