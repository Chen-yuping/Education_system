{% extends 'teacher/course_management_base.html' %}

{% block title %}知识点管理 - 在线学习诊断系统{% endblock %}

{% block content %}
<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 32px;
        padding-bottom: 20px;
        border-bottom: 2px solid #f0f0f0;
    }

    .page-title {
        font-size: 28px;
        font-weight: 700;
        color: #1a1a1a;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .page-title i {
        color: #667eea;
        font-size: 32px;
    }

    .search-section {
        margin-bottom: 28px;
    }

    .search-form {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .search-form input {
        flex: 1;
        max-width: 400px;
        padding: 12px 16px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .search-form input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        outline: none;
    }

    .search-form .btn {
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .kp-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
    }

    .kp-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        border: 1px solid #f0f0f0;
        display: flex;
        flex-direction: column;
    }

    .kp-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        border-color: #667eea;
    }

    .kp-card-header {
        margin-bottom: 16px;
    }

    .kp-name {
        font-size: 18px;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 8px;
        word-break: break-word;
    }

    .kp-stats {
        display: flex;
        gap: 16px;
        margin-bottom: 16px;
        padding-bottom: 16px;
        border-bottom: 1px solid #f0f0f0;
    }

    .kp-stat {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        color: #666;
    }

    .kp-stat i {
        color: #667eea;
        font-size: 14px;
    }

    .kp-stat-value {
        font-weight: 700;
        color: #1a1a1a;
    }

    .kp-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .kp-actions .btn {
        flex: 1;
        min-width: 100px;
        padding: 10px 12px;
        font-size: 12px;
        border-radius: 6px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }

    .btn-link {
        background: #667eea;
        color: white;
    }

    .btn-link:hover {
        background: #5568d3;
    }

    .btn-edit {
        background: #f59e0b;
        color: white;
    }

    .btn-edit:hover {
        background: #d97706;
    }

    .btn-delete {
        background: #ef4444;
        color: white;
    }

    .btn-delete:hover {
        background: #dc2626;
    }

    .empty-state {
        text-align: center;
        padding: 80px 40px;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        border-radius: 12px;
        margin: 40px 0;
    }

    .empty-state i {
        font-size: 64px;
        color: #667eea;
        margin-bottom: 20px;
        opacity: 0.8;
    }

    .empty-state h5 {
        font-size: 20px;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 12px;
    }

    .empty-state p {
        color: #666;
        margin-bottom: 24px;
        font-size: 14px;
    }

    .pagination {
        margin-top: 32px;
        justify-content: center;
    }

    .pagination .page-link {
        border-radius: 6px;
        border: 1px solid #e0e0e0;
        color: #667eea;
        margin: 0 4px;
        padding: 8px 12px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .pagination .page-link:hover {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }

    .pagination .page-item.active .page-link {
        background: #667eea;
        border-color: #667eea;
        color: white;
    }

    .btn-outline-custom {
        background: white;
        color: #667eea;
        border: 2px solid #667eea;
    }

    .btn-outline-custom:hover {
        background: #667eea;
        color: white;
    }
</style>

<div class="page-header" style="border-bottom: none; margin-bottom: 0; padding-bottom: 0;">
    <!-- 移除了页面标题 -->
</div>

<!-- 搜索框和添加按钮放在一行 -->
{% if page_obj or search %}
<div class="search-section">
    <form method="get" class="search-form">
        <input type="text" name="search" placeholder="搜索知识点名称..." value="{{ search }}">
        <button type="submit" class="btn btn-primary" style="padding: 12px 24px; border-radius: 8px; font-weight: 600;">
            <i class="fas fa-search me-2"></i> 搜索
        </button>
        {% if search %}
            <a href="{% url 'knowledge_point_list' subject_id=subject.id %}" class="btn btn-outline-custom">
                <i class="fas fa-times me-2"></i> 清除
            </a>
        {% endif %}
        <button type="button" class="btn btn-primary" style="padding: 12px 24px; border-radius: 8px; font-weight: 600; margin-left: auto;" onclick="openAddKnowledgePointModal()">
            <i class="fas fa-plus me-2"></i> 添加知识点
        </button>
        <button type="button" class="btn btn-success" style="padding: 12px 24px; border-radius: 8px; font-weight: 600; margin-left: 8px;" onclick="openBatchUploadModal()">
            <i class="fas fa-upload me-2"></i> 批量上传
        </button>
    </form>
</div>
{% else %}
<div class="search-section">
    <div class="search-form">
        <button type="button" class="btn btn-primary" style="padding: 12px 24px; border-radius: 8px; font-weight: 600; margin-left: auto;" onclick="openAddKnowledgePointModal()">
            <i class="fas fa-plus me-2"></i> 添加知识点
        </button>
        <button type="button" class="btn btn-success" style="padding: 12px 24px; border-radius: 8px; font-weight: 600; margin-left: 8px;" onclick="openBatchUploadModal()">
            <i class="fas fa-upload me-2"></i> 批量上传
        </button>
    </div>
</div>
{% endif %}

<!-- 知识点列表 -->
{% if page_obj %}
    <div class="kp-grid">
        {% for kp in page_obj %}
            <div class="kp-card">
                <div class="kp-card-header">
                    <div class="kp-name">{{ kp.name }}</div>
                </div>

                <div class="kp-stats">
                    <div class="kp-stat">
                        <i class="fas fa-book"></i>
                        <span>习题: <span class="kp-stat-value">{{ kp.exercise_count }}</span></span>
                    </div>
                    {% if kp.children.count %}
                        <div class="kp-stat">
                            <i class="fas fa-sitemap"></i>
                            <span>子点: <span class="kp-stat-value">{{ kp.children.count }}</span></span>
                        </div>
                    {% endif %}
                </div>

                {% if kp.parent %}
                    <div style="font-size: 12px; color: #666; margin-bottom: 12px; padding: 8px 12px; background: #f5f5f5; border-radius: 6px;">
                        <i class="fas fa-arrow-up" style="color: #667eea;"></i>
                        <span>父知识点: <strong>{{ kp.parent.name }}</strong></span>
                    </div>
                {% endif %}

                <div class="kp-actions">
                    <button class="btn btn-link" title="管理关联习题" onclick="openAssociationModal({{ kp.id }}, '{{ kp.name|escapejs }}')">
                        <i class="fas fa-link"></i> 关联
                    </button>
                    <button class="btn btn-edit" title="编辑" onclick="openEditModal({{ kp.id }}, '{{ kp.name|escapejs }}')">
                        <i class="fas fa-edit"></i> 编辑
                    </button>
                    <button class="btn btn-delete" title="删除" onclick="openDeleteModal({{ kp.id }}, '{{ kp.name|escapejs }}')">
                        <i class="fas fa-trash"></i> 删除
                    </button>
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- 分页 -->
    {% if page_obj.has_other_pages %}
        <nav aria-label="Page navigation">
            <ul class="pagination">
                {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% if search %}&search={{ search }}{% endif %}">
                            <i class="fas fa-chevron-left"></i> 首页
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search %}&search={{ search }}{% endif %}">
                            上一页
                        </a>
                    </li>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ num }}{% if search %}&search={{ search }}{% endif %}">{{ num }}</a>
                        </li>
                    {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search %}&search={{ search }}{% endif %}">
                            下一页
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if search %}&search={{ search }}{% endif %}">
                            末页 <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                {% endif %}
            </ul>
        </nav>
    {% endif %}
{% else %}
    <div class="empty-state">
        <i class="fas fa-lightbulb"></i>
        <h5>暂无知识点</h5>
        <p>点击下方按钮添加知识点开始管理</p>
        <button type="button" class="btn btn-primary" style="padding: 12px 24px; border-radius: 8px; font-weight: 600; display: inline-block;" onclick="openAddKnowledgePointModal()">
            <i class="fas fa-plus me-2"></i> 添加知识点
        </button>
    </div>
{% endif %}



<!-- 添加知识点弹窗 -->
<div class="modal fade" id="addKnowledgePointModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>添加知识点
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addKnowledgePointForm" method="post" action="{% url 'knowledge_point_add' subject_id=subject.id %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-heading me-2"></i>知识点名称
                            <span style="color: #ef4444;">*</span>
                        </label>
                        <input type="text" class="form-control" id="addKpName" name="name" placeholder="例如：一次函数、二次函数等" required>
                        <small class="text-muted d-block mt-2">
                            <i class="fas fa-lightbulb me-1"></i>输入清晰、简洁的知识点名称
                        </small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-sitemap me-2"></i>父知识点（可选）
                        </label>
                        <select class="form-select" id="addKpParent" name="parent">
                            <option value="">-- 无父知识点 --</option>
                            {% for kp in all_knowledge_points %}
                                <option value="{{ kp.id }}">{{ kp.name }}</option>
                            {% endfor %}
                        </select>
                        <small class="text-muted d-block mt-2">
                            <i class="fas fa-lightbulb me-1"></i>选择此知识点的上级知识点，用于构建知识点层级
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="submitAddKnowledgePoint()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑知识点弹窗 -->
<div class="modal fade" id="editKnowledgePointModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" style="word-break: break-word; max-width: 90%;">
                    <i class="fas fa-edit me-2"></i>编辑知识点
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editKnowledgePointForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label fw-bold">知识点名称</label>
                        <input type="text" class="form-control" id="kpName" name="name" required style="word-break: break-word;">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">父知识点</label>
                        <select class="form-select" id="kpParent" name="parent">
                            <option value="">-- 无 --</option>
                            {% for kp in all_knowledge_points %}
                                <option value="{{ kp.id }}">{{ kp.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveKnowledgePoint()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 关联习题弹窗 -->
<div class="modal fade" id="associationModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content" style="display: flex; flex-direction: column; max-height: 90vh;">
            <div class="modal-header bg-primary text-white" style="flex-wrap: wrap; flex-shrink: 0;">
                <h5 class="modal-title" style="word-break: break-word; max-width: 85%;">
                    <i class="fas fa-link me-2"></i>管理习题关联 - <span id="associationKpName"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="flex: 1; overflow: hidden; display: flex; flex-direction: column; padding: 0;">
                <div style="display: flex; flex: 1; gap: 12px; padding: 20px; overflow: hidden;">
                    <!-- 左列：已关联的习题 -->
                    <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                        <h6 class="mb-3" style="flex-shrink: 0;"><i class="fas fa-check-circle me-2" style="color: #10b981;"></i>已关联习题</h6>
                        <div class="flex-grow-1 border rounded p-3" id="associatedExercisesList" style="background: #f8f9fa; overflow-y: auto; overflow-x: hidden;">
                            <div class="text-center text-muted py-5">
                                <i class="fas fa-inbox fa-2x mb-2"></i>
                                <p>暂无已关联习题</p>
                            </div>
                        </div>
                    </div>
                    <!-- 右列：全部习题 -->
                    <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                        <h6 class="mb-3" style="flex-shrink: 0;"><i class="fas fa-book me-2" style="color: #667eea;"></i>全部习题</h6>
                        <input type="text" class="form-control form-control-sm mb-3" id="exerciseSearchInput" placeholder="搜索习题..." style="flex-shrink: 0;">
                        <div class="flex-grow-1 border rounded p-3" id="allExercisesList" style="background: #f8f9fa; overflow-y: auto; overflow-x: hidden;">
                            <div class="text-center text-muted py-5">
                                <i class="fas fa-inbox fa-2x mb-2"></i>
                                <p>加载中...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="flex-shrink: 0;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 删除确认弹窗 -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>删除确认
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>确定要删除知识点 <strong id="deleteKpName"></strong> 吗？</p>
                <p class="text-muted small">此操作无法撤销。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">删除</button>
            </div>
        </div>
    </div>
</div>

<!-- 批量上传知识点弹窗 -->
<div class="modal fade" id="batchUploadModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-upload me-2"></i>批量上传知识点
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        <i class="fas fa-file-csv me-2"></i>选择CSV文件
                        <span style="color: #ef4444;">*</span>
                    </label>
                    <input type="file" class="form-control" id="batchUploadFile" accept=".csv" required>
                    <small class="text-muted d-block mt-2">
                        <i class="fas fa-lightbulb me-1"></i>CSV格式：每行一个知识点，格式为 "知识点名称" 或 "知识点名称,父知识点名称"
                    </small>
                </div>
                <div class="alert alert-info" role="alert">
                    <h6 class="alert-heading">
                        <i class="fas fa-info-circle me-2"></i>文件格式说明
                    </h6>
                    <p class="mb-2">CSV文件应包含以下列（用逗号分隔）：</p>
                    <ul class="mb-0">
                        <li><strong>第1列：知识点名称</strong>（必填）</li>
                        <li><strong>第2列：父知识点名称</strong>（可选，用于创建层级关系）</li>
                    </ul>
                    <p class="mt-3 mb-0"><strong>示例：</strong></p>
                    <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; margin-top: 8px;">一次函数
二次函数,函数
三角函数,函数
正弦函数,三角函数</pre>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-success" onclick="submitBatchUpload()">
                    <i class="fas fa-upload me-2"></i>上传
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .exercise-item {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 10px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 10px;
    }

    .exercise-item:hover {
        border-color: #667eea;
        background: #f0f4ff;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
    }

    .exercise-item.associated {
        border-color: #10b981;
        background: #f0fdf4;
    }

    .exercise-content {
        flex: 1;
        min-width: 0;
    }

    .exercise-title {
        font-size: 13px;
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 4px;
        word-break: break-word;
    }

    .exercise-text {
        font-size: 12px;
        color: #666;
        line-height: 1.3;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        word-break: break-word;
    }

    .exercise-type {
        display: inline-block;
        background: #667eea;
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 10px;
        font-weight: 600;
        margin-top: 4px;
    }

    .exercise-btn {
        padding: 4px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 11px;
        font-weight: 600;
        transition: all 0.3s ease;
        white-space: nowrap;
        flex-shrink: 0;
    }

    .exercise-btn-add {
        background: #667eea;
        color: white;
    }

    .exercise-btn-add:hover {
        background: #5568d3;
    }

    .exercise-btn-remove {
        background: #ef4444;
        color: white;
    }

    .exercise-btn-remove:hover {
        background: #dc2626;
    }
</style>

<script>
let currentKpId = null;
let currentKpName = null;
let allExercises = [];
let associatedExerciseIds = new Set();
let deleteKpId = null;
let deleteKpName = null;
let subjectId = null;

// 获取科目ID
function getSubjectId() {
    if (!subjectId) {
        const pathParts = window.location.pathname.split('/');
        subjectId = pathParts[pathParts.length - 2];
    }
    return subjectId;
}

// 打开添加知识点弹窗
function openAddKnowledgePointModal() {
    const modal = new bootstrap.Modal(document.getElementById('addKnowledgePointModal'));
    modal.show();
}

// 提交添加知识点表单
function submitAddKnowledgePoint() {
    const form = document.getElementById('addKnowledgePointForm');
    const name = document.getElementById('addKpName').value;
    
    if (!name.trim()) {
        alert('知识点名称不能为空');
        return;
    }
    
    form.submit();
}

// 打开删除确认弹窗
function openDeleteModal(kpId, kpName) {
    deleteKpId = kpId;
    deleteKpName = kpName;
    document.getElementById('deleteKpName').textContent = kpName;
    
    const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    modal.show();
}

// 确认删除
function confirmDelete() {
    if (!deleteKpId) return;
    
    const subId = getSubjectId();
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/learning/teacher/knowledge-points/${subId}/${deleteKpId}/delete/`;
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = csrfToken;
    
    form.appendChild(csrfInput);
    document.body.appendChild(form);
    form.submit();
}

// 打开编辑弹窗
function openEditModal(kpId, kpName) {
    currentKpId = kpId;
    
    // 从页面加载知识点数据
    fetch(`/learning/teacher/api/knowledge-point/${kpId}/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            document.getElementById('kpName').value = data.knowledge_point.name;
            document.getElementById('kpParent').value = data.knowledge_point.parent_id || '';
            
            const modal = new bootstrap.Modal(document.getElementById('editKnowledgePointModal'));
            modal.show();
        } else {
            alert('加载失败: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('加载失败: ' + error.message);
    });
}

// 保存知识点
function saveKnowledgePoint() {
    const name = document.getElementById('kpName').value;
    const parent = document.getElementById('kpParent').value;
    
    if (!name.trim()) {
        alert('知识点名称不能为空');
        return;
    }
    
    fetch(`/learning/teacher/api/knowledge-point/${currentKpId}/update/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            name: name,
            parent: parent || null
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            alert('知识点已更新');
            location.reload();
        } else {
            alert('更新失败: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('更新失败: ' + error.message);
    });
}

// 打开关联弹窗
function openAssociationModal(kpId, kpName) {
    currentKpId = kpId;
    currentKpName = kpName;
    document.getElementById('associationKpName').textContent = kpName;
    
    // 加载习题数据
    loadExercisesForAssociation();
    
    const modal = new bootstrap.Modal(document.getElementById('associationModal'));
    modal.show();
}

// 加载习题数据
function loadExercisesForAssociation() {
    fetch(`/learning/teacher/api/knowledge-point/${currentKpId}/exercises/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            allExercises = data.all_exercises;
            associatedExerciseIds = new Set(data.associated_exercise_ids);
            renderExerciseLists();
        } else {
            alert('加载失败: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('加载失败: ' + error.message);
    });
}

// 渲染习题列表
function renderExerciseLists() {
    // 渲染已关联习题
    const associatedList = document.getElementById('associatedExercisesList');
    const associatedExercises = allExercises.filter(ex => associatedExerciseIds.has(ex.id));
    
    if (associatedExercises.length === 0) {
        associatedList.innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="fas fa-inbox fa-2x mb-2"></i>
                <p>暂无已关联习题</p>
            </div>
        `;
    } else {
        associatedList.innerHTML = associatedExercises.map(ex => `
            <div class="exercise-item associated" data-exercise-id="${ex.id}">
                <div class="exercise-content">
                    <div class="exercise-title">${ex.title}</div>
                    <div class="exercise-text">${ex.content}</div>
                    <span class="exercise-type">${ex.question_type}</span>
                </div>
                <button class="exercise-btn exercise-btn-remove" onclick="removeAssociation(${ex.id})">
                    <i class="fas fa-times"></i> 取消
                </button>
            </div>
        `).join('');
    }
    
    // 渲染全部习题
    renderAllExercises();
}

// 渲染全部习题
function renderAllExercises() {
    const allList = document.getElementById('allExercisesList');
    const searchText = document.getElementById('exerciseSearchInput').value.toLowerCase();
    
    const filteredExercises = allExercises.filter(ex => 
        ex.title.toLowerCase().includes(searchText) || 
        ex.content.toLowerCase().includes(searchText)
    );
    
    if (filteredExercises.length === 0) {
        allList.innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="fas fa-inbox fa-2x mb-2"></i>
                <p>暂无习题</p>
            </div>
        `;
    } else {
        allList.innerHTML = filteredExercises.map(ex => {
            const isAssociated = associatedExerciseIds.has(ex.id);
            return `
                <div class="exercise-item ${isAssociated ? 'associated' : ''}" data-exercise-id="${ex.id}">
                    <div class="exercise-content">
                        <div class="exercise-title">${ex.title}</div>
                        <div class="exercise-text">${ex.content}</div>
                        <span class="exercise-type">${ex.question_type}</span>
                    </div>
                    <button class="exercise-btn ${isAssociated ? 'exercise-btn-remove' : 'exercise-btn-add'}" 
                            onclick="${isAssociated ? `removeAssociation(${ex.id})` : `addAssociation(${ex.id})`}">
                        <i class="fas ${isAssociated ? 'fa-times' : 'fa-plus'}"></i> ${isAssociated ? '取消' : '关联'}
                    </button>
                </div>
            `;
        }).join('');
    }
}

// 添加关联
function addAssociation(exerciseId) {
    fetch(`/learning/teacher/api/knowledge-point/${currentKpId}/toggle-exercise/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ exercise_id: exerciseId })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            associatedExerciseIds.add(exerciseId);
            renderExerciseLists();
        } else {
            alert('操作失败: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('操作失败: ' + error.message);
    });
}

// 移除关联
function removeAssociation(exerciseId) {
    fetch(`/learning/teacher/api/knowledge-point/${currentKpId}/toggle-exercise/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ exercise_id: exerciseId })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            associatedExerciseIds.delete(exerciseId);
            renderExerciseLists();
        } else {
            alert('操作失败: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('操作失败: ' + error.message);
    });
}

// 打开批量上传弹窗
function openBatchUploadModal() {
    const modal = new bootstrap.Modal(document.getElementById('batchUploadModal'));
    modal.show();
}

// 提交批量上传
function submitBatchUpload() {
    const fileInput = document.getElementById('batchUploadFile');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('请选择CSV文件');
        return;
    }
    
    if (!file.name.endsWith('.csv')) {
        alert('请选择CSV格式的文件');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    
    const subId = getSubjectId();
    
    // 显示上传中状态
    const submitBtn = event.target;
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>上传中...';
    
    fetch(`/learning/teacher/knowledge-points/${subId}/batch-upload/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        
        if (data.success) {
            alert(`成功上传 ${data.created_count} 个知识点，${data.skipped_count} 个已存在`);
            
            // 关闭弹窗
            const modal = bootstrap.Modal.getInstance(document.getElementById('batchUploadModal'));
            modal.hide();
            
            // 重新加载页面
            location.reload();
        } else {
            alert('上传失败: ' + data.message);
        }
    })
    .catch(error => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        console.error('Error:', error);
        alert('上传失败: ' + error.message);
    });
}

// 搜索习题
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('exerciseSearchInput');
    if (searchInput) {
        searchInput.addEventListener('input', renderAllExercises);
    }
});
</script>
{% endblock %}
