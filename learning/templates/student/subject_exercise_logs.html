{% extends 'student/learning_base.html' %}

{% block title %}{{ subject.name }} - 做题记录{% endblock %}

{% block extra_css %}
<style>
    /* 统计卡片样式 */
    .stat-card {
        border-radius: 10px;
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        height: 100%;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }

    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
    }

    .total-icon {
        background: linear-gradient(135deg, #667eea, #764ba2);
    }

    .correct-icon {
        background: linear-gradient(135deg, #28a745, #20c997);
    }

    .incorrect-icon {
        background: linear-gradient(135deg, #f093fb, #f5576c);
    }

    .accuracy-icon {
        background: linear-gradient(135deg, #4facfe, #00f2fe);
    }

    /* 图表卡片 */
    .chart-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .chart-title {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .chart-title i {
        color: #007bff;
    }

    .chart-container {
        width: 100%;
        height: 300px;
    }

    /* 答题记录网格 */
    .answer-grid {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
    }

    .answer-dot {
        width: 26px;
        height: 26px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 2px solid transparent;
    }

    .answer-dot:hover {
        transform: scale(1.2);
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .answer-dot.correct {
        background-color: #28a745;
        color: white;
    }

    .answer-dot.incorrect {
        background-color: #dc3545;
        color: white;
    }

    .answer-dot.unmarked {
        background-color: #6c757d;
        color: white;
    }

    /* 题目详情模态框样式 */
    .question-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        z-index: 1050;
        overflow-y: auto;
    }

    .question-modal-content {
        background-color: white;
        margin: 50px auto;
        width: 90%;
        max-width: 800px;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .question-modal-header {
        padding: 20px;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .question-modal-body {
        padding: 20px;
        max-height: 60vh;
        overflow-y: auto;
    }

    .question-status-badge {
        font-size: 14px;
        padding: 5px 10px;
        border-radius: 20px;
    }

    .answer-options {
        margin-top: 20px;
    }

    .answer-option {
        padding: 12px 15px;
        margin-bottom: 10px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .answer-option.selected {
        border-color: #007bff;
        background-color: rgba(0,123,255,0.1);
    }

    .answer-option.correct {
        border-color: #28a745;
        background-color: rgba(40,167,69,0.1);
    }

    .answer-option.incorrect {
        border-color: #dc3545;
        background-color: rgba(220,53,69,0.1);
    }

    /* 习题表格 */
    .exercise-table {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .table-header {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 15px 20px;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}

{% if has_data %}
<!-- 统计卡片 -->
<div class="row mb-4">
    

    <div class="col-md-3 mb-3">
        <div class="card stat-card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="stat-icon correct-icon me-3">
                        <i class="fas fa-book"></i>
                    </div>
                    <div>
                        <h3 class="mb-0">{{ total_exercises }}</h3>
                        <p class="text-muted mb-0">习题总数</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-3">
        <div class="card stat-card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="stat-icon incorrect-icon me-3">
                        <i class="fas fa-check-double"></i>
                    </div>
                    <div>
                        <h3 class="mb-0">{{ completed_exercises }}</h3>
                        <p class="text-muted mb-0">已完成习题</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card stat-card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="stat-icon total-icon me-3">
                        <i class="fas fa-list-alt"></i>
                    </div>
                    <div>
                        <h3 class="mb-0">{{ total_logs }}</h3>
                        <p class="text-muted mb-0">总答题次数</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card stat-card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="stat-icon accuracy-icon me-3">
                        <i class="fas fa-percentage"></i>
                    </div>
                    <div>
                        <h3 class="mb-0">{{ correct_rate }}%</h3>
                        <p class="text-muted mb-0">正确率</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 图表区域 -->
<div class="row mb-4">
    <!-- 答题趋势图 -->
    <div class="col-md-8 mb-3">
        <div class="chart-card">
            <div class="chart-title">
                <i class="fas fa-chart-line"></i>
                答题趋势分析
            </div>
            <div class="chart-container" id="trendChart"></div>
        </div>
    </div>

    <!-- 正确率饼图 -->
    <div class="col-md-4 mb-3">
        <div class="chart-card">
            <div class="chart-title">
                <i class="fas fa-chart-pie"></i>
                答题结果分布
            </div>
            <div class="chart-container" id="pieChart"></div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <!-- 每日答题活跃度 -->
    <div class="col-md-6 mb-3">
        <div class="chart-card">
            <div class="chart-title">
                <i class="fas fa-calendar-alt"></i>
                每日答题活跃度
            </div>
            <div class="chart-container" id="dailyChart"></div>
        </div>
    </div>

    <!-- 题型分布 -->
    <div class="col-md-6 mb-3">
        <div class="chart-card">
            <div class="chart-title">
                <i class="fas fa-tasks"></i>
                答题分布统计
            </div>
            <div class="chart-container" id="typeChart"></div>
        </div>
    </div>
</div>

<!-- 各习题答题情况 -->
<div class="exercise-table mb-4">
    <div class="table-header">
        <i class="fas fa-clipboard-list me-2"></i>各习题答题详情
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead>
                    <tr>
                        <th width="60">序号</th>
                        <th width="200">标题</th>
                        <th width="100">答题次数</th>
                        <th>最近答题记录</th>
                        <th width="120">操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for exercise in exercises_with_stats %}
                    <tr>
                        <td class="fw-bold text-center">{{ forloop.counter }}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <span class="fw-semibold">{{ exercise.title|truncatechars:30 }}</span>
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-primary">{{ exercise.total_attempts }}次</span>
                        </td>
                        <td>
                            <div class="answer-grid" data-exercise-id="{{ exercise.id }}">
                                {% for log in exercise.recent_logs %}
                                <div class="answer-dot
                                    {% if log.is_correct == True %}correct
                                    {% elif log.is_correct == False %}incorrect
                                    {% else %}unmarked{% endif %}"
                                     data-log-id="{{ log.id }}"
                                     data-question="{{ log.question_text|escapejs }}"
                                     data-question-type="{{ log.question_type }}"
                                     data-selected-option="{{ log.selected_option|escapejs }}"
                                     data-correct-option="{{ log.correct_option|escapejs }}"
                                     data-options='{{ log.options_json }}'
                                     data-text-answer="{{ log.text_answer|escapejs }}"
                                     data-status="{% if log.is_correct == True %}correct{% elif log.is_correct == False %}incorrect{% else %}unmarked{% endif %}"
                                     data-time="{{ log.submitted_at|date:'Y-m-d H:i:s' }}">
                                    {{ forloop.counter }}
                                </div>
                                {% empty %}
                                <span class="text-muted small">暂无记录</span>
                                {% endfor %}
                            </div>
                        </td>
                        <td>
                            {% if exercise.recent_logs %}
                            <button class="btn btn-sm btn-outline-info view-details-btn"
                                    data-exercise-id="{{ exercise.id }}">
                                <i class="fas fa-history me-1"></i>查看详情
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center py-4 text-muted">
                            <i class="fas fa-inbox fa-2x mb-3"></i>
                            <p>暂无答题数据</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% else %}
<!-- 无数据提示 -->
<div class="text-center py-5">
    <i class="fas fa-history fa-4x text-muted mb-3"></i>
    <h3 class="text-muted">暂无答题记录</h3>
    <p class="text-muted mb-4">您还没有在该科目下答题，快去开始学习吧！</p>
    <a href="{% url 'subject_learning' subject_id=subject.id %}" class="btn btn-primary btn-lg">
        <i class="fas fa-play-circle me-2"></i>开始答题
    </a>
</div>
{% endif %}

<!-- 题目详情模态框 -->
<div id="questionModal" class="question-modal">
    <div class="question-modal-content">
        <div class="question-modal-header">
            <h5 class="modal-title">答题详情</h5>
            <button type="button" class="btn-close" onclick="closeQuestionModal()"></button>
        </div>
        <div class="question-modal-body">
            <div class="mb-3">
                <span id="questionStatusBadge" class="question-status-badge"></span>
                <small class="text-muted ms-2" id="questionTime"></small>
            </div>
            <div id="questionContent" class="mb-4"></div>
            <div class="answer-options" id="answerOptions"></div>
        </div>
        <div class="question-modal-header border-top">
            <button type="button" class="btn btn-secondary" onclick="closeQuestionModal()">关闭</button>
            <div class="btn-group">
                <button type="button" class="btn btn-outline-primary" id="prevQuestionBtn">
                    <i class="fas fa-chevron-left me-1"></i>上一个
                </button>
                <button type="button" class="btn btn-outline-primary" id="nextQuestionBtn">
                    下一个<i class="fas fa-chevron-right ms-1"></i>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script>
// 当前查看的题目索引
let currentQuestionIndex = 0;
let currentQuestions = [];

{% if has_data %}
// 初始化图表
document.addEventListener('DOMContentLoaded', function() {
    initCharts();
});

function initCharts() {
    // 1. 答题趋势图
    const trendChart = echarts.init(document.getElementById('trendChart'));
    const trendOption = {
        tooltip: {
            trigger: 'axis'
        },
        legend: {
            data: ['答题次数', '正确次数']
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            containLabel: true
        },
        xAxis: {
            type: 'category',
            data: {{ trend_dates|safe }}
        },
        yAxis: {
            type: 'value'
        },
        series: [
            {
                name: '答题次数',
                type: 'line',
                data: {{ trend_total|safe }},
                smooth: true,
                itemStyle: { color: '#667eea' }
            },
            {
                name: '正确次数',
                type: 'line',
                data: {{ trend_correct|safe }},
                smooth: true,
                itemStyle: { color: '#28a745' }
            }
        ]
    };
    trendChart.setOption(trendOption);

    // 2. 正确率饼图
    const pieChart = echarts.init(document.getElementById('pieChart'));
    const pieOption = {
        tooltip: {
            trigger: 'item',
            formatter: '{b}: {c} ({d}%)'
        },
        series: [
            {
                type: 'pie',
                radius: ['40%', '70%'],
                avoidLabelOverlap: false,
                itemStyle: {
                    borderRadius: 10,
                    borderColor: '#fff',
                    borderWidth: 2
                },
                label: {
                    show: true,
                    formatter: '{b}\n{d}%'
                },
                data: [
                    { value: {{ correct_logs }}, name: '正确', itemStyle: { color: '#28a745' } },
                    { value: {{ incorrect_logs }}, name: '错误', itemStyle: { color: '#dc3545' } },
                    { value: {{ unmarked_logs }}, name: '未批改', itemStyle: { color: '#6c757d' } }
                ]
            }
        ]
    };
    pieChart.setOption(pieOption);

    // 3. 每日答题活跃度
    const dailyChart = echarts.init(document.getElementById('dailyChart'));
    const dailyOption = {
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'shadow'
            }
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            containLabel: true
        },
        xAxis: {
            type: 'category',
            data: {{ daily_dates|safe }}
        },
        yAxis: {
            type: 'value'
        },
        series: [
            {
                type: 'bar',
                data: {{ daily_counts|safe }},
                itemStyle: {
                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                        { offset: 0, color: '#4facfe' },
                        { offset: 1, color: '#00f2fe' }
                    ])
                },
                barWidth: '60%'
            }
        ]
    };
    dailyChart.setOption(dailyOption);

    // 4. 题型分布
    const typeChart = echarts.init(document.getElementById('typeChart'));
    const typeOption = {
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'shadow'
            }
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            containLabel: true
        },
        xAxis: {
            type: 'value'
        },
        yAxis: {
            type: 'category',
            data: {{ type_names|safe }}
        },
        series: [
            {
                type: 'bar',
                data: {{ type_counts|safe }},
                itemStyle: {
                    color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                        { offset: 0, color: '#667eea' },
                        { offset: 1, color: '#764ba2' }
                    ])
                }
            }
        ]
    };
    typeChart.setOption(typeOption);

    // 响应式调整
    window.addEventListener('resize', function() {
        trendChart.resize();
        pieChart.resize();
        dailyChart.resize();
        typeChart.resize();
    });
}
{% endif %}

// 显示题目详情模态框
function showQuestionModal(logId) {
    const dot = document.querySelector(`.answer-dot[data-log-id="${logId}"]`);
    if (!dot) return;

    const modal = document.getElementById('questionModal');
    const questionContent = document.getElementById('questionContent');
    const answerOptions = document.getElementById('answerOptions');
    const questionStatusBadge = document.getElementById('questionStatusBadge');
    const questionTime = document.getElementById('questionTime');

    // 获取题目数据
    const questionText = dot.getAttribute('data-question');
    const questionType = dot.getAttribute('data-question-type');
    const selectedOption = dot.getAttribute('data-selected-option');
    const correctOption = dot.getAttribute('data-correct-option');
    const textAnswer = dot.getAttribute('data-text-answer');
    const status = dot.getAttribute('data-status');
    const time = dot.getAttribute('data-time');

    // 解析选项数据
    let options = [];
    try {
        const optionsStr = dot.getAttribute('data-options');
        options = JSON.parse(optionsStr);
    } catch (e) {
        console.error('Error parsing options:', e);
        options = [];
    }

    // 设置状态标签
    let statusText = '';
    let badgeClass = '';
    if (status === 'correct') {
        statusText = '正确';
        badgeClass = 'bg-success';
    } else if (status === 'incorrect') {
        statusText = '错误';
        badgeClass = 'bg-danger';
    } else {
        statusText = '未批改';
        badgeClass = 'bg-secondary';
    }

    questionStatusBadge.className = `question-status-badge badge ${badgeClass}`;
    questionStatusBadge.textContent = statusText;

    // 设置时间
    const timeObj = new Date(time);
    questionTime.textContent = timeObj.toLocaleString('zh-CN');

    // 设置题目内容
    questionContent.innerHTML = `
        <h6>题目：</h6>
        <div class="p-3 bg-light rounded">${questionText || '题目内容加载中...'}</div>
    `;

    // 清空并重新设置选项或答案
    answerOptions.innerHTML = '';
    
    // 判断题型：主观题（类型5）显示文本答案，其他显示选项
    if (questionType === '5') {
        // 主观题：显示文本答案
        answerOptions.innerHTML = `
            <h6>我的作答：</h6>
            <div class="p-3 bg-light rounded" style="white-space: pre-wrap; line-height: 1.8;">
                ${textAnswer || '未作答'}
            </div>
        `;
    } else if (options && options.length > 0) {
        // 选择题：显示选项
        answerOptions.innerHTML = '<h6>选项：</h6>';
        
        // 解析用户选择和正确答案（可能是多个，用 " | " 分隔）
        const selectedOptions = selectedOption ? selectedOption.split(' | ').map(s => s.trim()) : [];
        const correctOptions = correctOption ? correctOption.split(' | ').map(s => s.trim()) : [];
        
        options.forEach((option, index) => {
            const optionDiv = document.createElement('div');
            optionDiv.className = 'answer-option';

            // 检查当前选项是否被选择或是正确答案
            const optionText = option.trim();
            const isSelected = selectedOptions.some(selected => optionText === selected || optionText.includes(selected) || selected.includes(optionText));
            const isCorrect = correctOptions.some(correct => optionText === correct || optionText.includes(correct) || correct.includes(optionText));

            // 添加相应的类
            if (isSelected && isCorrect) {
                optionDiv.classList.add('selected', 'correct');
            } else if (isSelected && !isCorrect) {
                optionDiv.classList.add('selected', 'incorrect');
            } else if (!isSelected && isCorrect) {
                optionDiv.classList.add('correct');
            }

            optionDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <span class="me-2">${String.fromCharCode(65 + index)}.</span>
                    <div class="flex-grow-1">${option}</div>
                    ${isSelected ? '<span class="badge bg-info ms-2">您的选择</span>' : ''}
                    ${isCorrect ? '<span class="badge bg-success ms-2">正确答案</span>' : ''}
                </div>
            `;

            answerOptions.appendChild(optionDiv);
        });
    } else {
        answerOptions.innerHTML = '<p class="text-muted">选项信息不可用</p>';
    }

    // 显示模态框
    modal.style.display = 'block';
}

// 关闭题目详情模态框
function closeQuestionModal() {
    const modal = document.getElementById('questionModal');
    modal.style.display = 'none';
    currentQuestionIndex = 0;
    currentQuestions = [];
}

// 加载当前习题的所有答题记录
function loadExerciseQuestions(exerciseId) {
    const dots = document.querySelectorAll(`.answer-grid[data-exercise-id="${exerciseId}"] .answer-dot`);
    currentQuestions = Array.from(dots).map(dot => ({
        logId: dot.getAttribute('data-log-id'),
        questionText: dot.getAttribute('data-question'),
        questionType: dot.getAttribute('data-question-type'),
        selectedOption: dot.getAttribute('data-selected-option'),
        correctOption: dot.getAttribute('data-correct-option'),
        options: dot.getAttribute('data-options'),
        textAnswer: dot.getAttribute('data-text-answer'),
        status: dot.getAttribute('data-status'),
        time: dot.getAttribute('data-time')
    }));

    if (currentQuestions.length > 0) {
        currentQuestionIndex = 0;
        showQuestion(currentQuestionIndex);
    }
}

// 显示指定索引的题目
function showQuestion(index) {
    if (index < 0 || index >= currentQuestions.length) return;

    currentQuestionIndex = index;
    const question = currentQuestions[index];

    // 更新按钮状态
    document.getElementById('prevQuestionBtn').disabled = index === 0;
    document.getElementById('nextQuestionBtn').disabled = index === currentQuestions.length - 1;

    // 显示题目
    showQuestionModal(question.logId);
}

// 初始化事件监听
document.addEventListener('DOMContentLoaded', function() {
    // 点击答题点
    document.querySelectorAll('.answer-dot').forEach(dot => {
        dot.addEventListener('click', function() {
            const logId = this.getAttribute('data-log-id');
            if (logId) {
                // 加载该习题的所有题目
                const exerciseId = this.closest('.answer-grid').getAttribute('data-exercise-id');
                loadExerciseQuestions(exerciseId);

                // 找到当前点击的题目索引
                const dots = Array.from(this.closest('.answer-grid').querySelectorAll('.answer-dot'));
                const clickedIndex = dots.findIndex(d => d.getAttribute('data-log-id') === logId);
                currentQuestionIndex = clickedIndex;

                showQuestionModal(logId);
            }
        });
    });

    // 点击查看详情按钮
    document.querySelectorAll('.view-details-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const exerciseId = this.getAttribute('data-exercise-id');
            loadExerciseQuestions(exerciseId);
        });
    });

    // 上一题按钮
    document.getElementById('prevQuestionBtn').addEventListener('click', function() {
        if (currentQuestionIndex > 0) {
            showQuestion(currentQuestionIndex - 1);
        }
    });

    // 下一题按钮
    document.getElementById('nextQuestionBtn').addEventListener('click', function() {
        if (currentQuestionIndex < currentQuestions.length - 1) {
            showQuestion(currentQuestionIndex + 1);
        }
    });

    // 点击模态框外部关闭
    document.getElementById('questionModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeQuestionModal();
        }
    });

    // ESC键关闭模态框
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeQuestionModal();
        }
    });
});
</script>
{% endblock %}
