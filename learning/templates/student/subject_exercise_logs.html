{% extends 'student/base.html' %}

{% block title %}{{ subject.name }} - 做题记录 - 在线学习诊断系统{% endblock %}

{% block content %}
<style>
    /* 基础布局样式 - 与你的页面保持一致 */
    .container.mt-4 {
        margin: 0 !important;
        padding: 0 !important;
        max-width: 100% !important;
        width: 100% !important;
    }

    /* 学生页面布局样式 */
    .student-container {
        display: flex;
        min-height: calc(100vh - 80px);
        margin-top: 20px;
    }

    /* 侧边栏样式 */
    .student-sidebar {
        width: 280px;
        background-color: #f8f9fa;
        border-right: 1px solid #dee2e6;
        flex-shrink: 0;
        padding: 0 10px 0;
    }

    /* 主内容区域 */
    .student-main-content {
        flex: 1;
        padding: 20px;
        min-height: 100%;
        background-color: #ffffff;
    }

    /* 侧边栏导航链接样式 */
    .sidebar-nav .nav-link {
        padding: 12px 20px;
        color: #333;
        border-radius: 0;
        border-left: 3px solid transparent;
        transition: all 0.2s ease;
    }

    .sidebar-nav .nav-link:hover {
        background-color: #e9ecef;
        color: #007bff;
        border-left-color: #007bff;
    }

    .sidebar-nav .nav-link.active {
        background-color: #007bff;
        color: white;
        border-left-color: #007bff;
    }

    .sidebar-nav .nav-link i {
        width: 20px;
        text-align: center;
        margin-right: 10px;
    }

    /* 统计卡片样式 */
    .stat-card {
        border-radius: 10px;
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        height: 100%;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }

    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
    }

    .total-icon {
        background: linear-gradient(135deg, #007bff, #339af0);
    }

    .correct-icon {
        background: linear-gradient(135deg, #28a745, #20c997);
    }

    .incorrect-icon {
        background: linear-gradient(135deg, #dc3545, #e35d6a);
    }

    .unmarked-icon {
        background: linear-gradient(135deg, #6c757d, #868e96);
    }

    /* 新添加的样式 */
    .answer-grid {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
    }

    .answer-dot {
        width: 26px;
        height: 26px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 2px solid transparent;
    }

    .answer-dot:hover {
        transform: scale(1.2);
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .answer-dot.correct {
        background-color: #28a745;
        color: white;
    }

    .answer-dot.incorrect {
        background-color: #dc3545;
        color: white;
    }

    .answer-dot.unmarked {
        background-color: #6c757d;
        color: white;
    }

    .answer-dot.current {
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0,123,255,0.2);
    }

    /* 题目详情模态框样式 */
    .question-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        z-index: 1050;
        overflow-y: auto;
    }

    .question-modal-content {
        background-color: white;
        margin: 50px auto;
        width: 90%;
        max-width: 800px;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .question-modal-header {
        padding: 20px;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .question-modal-body {
        padding: 20px;
        max-height: 60vh;
        overflow-y: auto;
    }

    .question-status-badge {
        font-size: 14px;
        padding: 5px 10px;
        border-radius: 20px;
    }

    .answer-options {
        margin-top: 20px;
    }

    .answer-option {
        padding: 12px 15px;
        margin-bottom: 10px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .answer-option.selected {
        border-color: #007bff;
        background-color: rgba(0,123,255,0.1);
    }

    .answer-option.correct {
        border-color: #28a745;
        background-color: rgba(40,167,69,0.1);
    }

    .answer-option.incorrect {
        border-color: #dc3545;
        background-color: rgba(220,53,69,0.1);
    }

    /* 移动设备响应式 */
    @media (max-width: 768px) {
        .student-container {
            flex-direction: column;
        }

        .student-sidebar {
            width: 100%;
            border-right: none;
            border-bottom: 1px solid #dee2e6;
        }

        .student-main-content {
            padding: 20px;
        }

        .answer-dot {
            width: 22px;
            height: 22px;
            font-size: 10px;
        }
    }
</style>

<div class="student-container">
    <!-- 左侧导航栏 -->
    <nav class="student-sidebar">
        <div class="sidebar-nav">
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link " href="{% url 'student_dashboard' %}">
                        <i class="fas fa-arrow-left"></i> 返回学习面板
                    </a>
                </li>
                 <li class="nav-item">
                    <a class="nav-link " href="{% url 'exercise_list' subject_id=subject.id %}">
                        <i class="fas fa-tachometer-alt"></i> 题目集介绍
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="{% url 'subject_exercise_logs' subject_id=subject.id %}">
                        <i class="fas fa-chart-line"></i> 做题记录
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'student_subject_diagnosis' subject_id=subject.id%}">
                        <i class="fas fa-chart-line"></i> 学习诊断
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- 右侧主内容区域 -->
    <main class="student-main-content">
        <!-- 页面标题 -->
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-3 mb-3 border-bottom">
            <div>
                <h1 class="h2">{{ subject.name }} - 做题记录</h1>
                <p class="text-muted mb-0">查看您在该科目下的所有答题历史</p>
            </div>
            <div class="btn-toolbar mb-2 mb-md-0">
                <a href="{% url 'exercise_list' subject_id=subject.id %}" class="btn btn-primary">
                    <i class="fas fa-magic me-1"></i>个性化习题推荐
                </a>
            </div>
        </div>

        {% if has_data %}
        <!-- 统计卡片 -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card stat-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="stat-icon total-icon me-3">
                                <i class="fas fa-list-alt"></i>
                            </div>
                            <div>
                                <h3 class="mb-0">{{ total_logs }}</h3>
                                <p class="text-muted mb-0">总答题次数</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-3">
                <div class="card stat-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="stat-icon correct-icon me-3">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div>
                                <h3 class="mb-0">{{ correct_logs }}</h3>
                                <p class="text-muted mb-0">正确次数</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-3">
                <div class="card stat-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="stat-icon incorrect-icon me-3">
                                <i class="fas fa-times-circle"></i>
                            </div>
                            <div>
                                <h3 class="mb-0">{{ incorrect_logs }}</h3>
                                <p class="text-muted mb-0">错误次数</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-3">
                <div class="card stat-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="stat-icon unmarked-icon me-3">
                                <i class="fas fa-question-circle"></i>
                            </div>
                            <div>
                                <h3 class="mb-0">{{ unmarked_logs }}</h3>
                                <p class="text-muted mb-0">未批改次数</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 各习题答题情况 - 新设计 -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">各习题答题情况</h5>
                <div class="text-muted small">
                    最近3个月答题记录，点击数字查看详情
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th width="60">序号</th>
                                <th>标题</th>
                                <th width="200">最近答题记录</th>
                                <th width="200">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for exercise in exercises_with_stats %}
                            <tr class="{% if forloop.counter|divisibleby:2 %}table-light{% endif %}">
                                <td class="fw-bold text-center">
                                    {{ forloop.counter }}
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <span class="fw-semibold">{{ exercise.title|truncatechars:25 }}</span>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-dark text-white">
                                        {{ exercise.total_attempts }}次
                                    </span>
                                </td>
                                <td>
                                    <div class="answer-grid" data-exercise-id="{{ exercise.id }}">
                                        {% for log in exercise.recent_logs %}
                                        <div class="answer-dot
                                            {% if log.is_correct == True %}correct
                                            {% elif log.is_correct == False %}incorrect
                                            {% else %}unmarked{% endif %}"
                                             data-log-id="{{ log.id }}"
                                             data-question="{{ log.question_text|escapejs }}"
                                             data-selected-option="{{ log.selected_option|escapejs }}"
                                             data-correct-option="{{ log.correct_option|escapejs }}"
                                             data-options="{{ log.options_json|escapejs }}"
                                             data-status="{% if log.is_correct == True %}correct{% elif log.is_correct == False %}incorrect{% else %}unmarked{% endif %}"
                                             data-time="{{ log.submitted_at|date:'Y-m-d H:i:s' }}">
                                            {{ forloop.counter }}
                                        </div>
                                        {% empty %}
                                        <span class="text-muted small">暂无答题记录</span>
                                        {% endfor %}
                                    </div>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{% url 'take_exercise' exercise.id %}"
                                           class="btn btn-outline-primary">
                                            <i class="fas fa-redo me-1"></i>再次答题
                                        </a>
                                        {% if exercise.recent_logs %}
                                        <button class="btn btn-outline-info view-details-btn"
                                                data-exercise-id="{{ exercise.id }}">
                                            <i class="fas fa-history me-1"></i>作答详情
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center py-4 text-muted">
                                    <i class="fas fa-inbox fa-2x mb-3"></i>
                                    <p>暂无答题数据</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        {% else %}
        <!-- 无数据提示 -->
        <div class="text-center py-5">
            <i class="fas fa-history fa-4x text-muted mb-3"></i>
            <h3 class="text-muted">暂无答题记录</h3>
            <p class="text-muted mb-4">您还没有在该科目下答题，快去开始学习吧！</p>
            <a href="{% url 'exercise_list' subject_id=subject.id %}" class="btn btn-primary btn-lg">
                <i class="fas fa-play-circle me-2"></i>开始答题
            </a>
        </div>
        {% endif %}
    </main>
</div>

<!-- 题目详情模态框 -->
<div id="questionModal" class="question-modal">
    <div class="question-modal-content">
        <div class="question-modal-header">
            <h5 class="modal-title">答题详情</h5>
            <button type="button" class="btn-close" onclick="closeQuestionModal()"></button>
        </div>
        <div class="question-modal-body">
            <div class="mb-3">
                <span id="questionStatusBadge" class="question-status-badge"></span>
                <small class="text-muted ms-2" id="questionTime"></small>
            </div>
            <div id="questionContent" class="mb-4"></div>
            <div class="answer-options" id="answerOptions"></div>
        </div>
        <div class="question-modal-header border-top">
            <button type="button" class="btn btn-secondary" onclick="closeQuestionModal()">关闭</button>
            <div class="btn-group">
                <button type="button" class="btn btn-outline-primary" id="prevQuestionBtn">
                    <i class="fas fa-chevron-left me-1"></i>上一个
                </button>
                <button type="button" class="btn btn-outline-primary" id="nextQuestionBtn">
                    下一个<i class="fas fa-chevron-right ms-1"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// 当前查看的题目索引
let currentQuestionIndex = 0;
let currentQuestions = [];

// 显示题目详情模态框
function showQuestionModal(logId) {
    const dot = document.querySelector(`.answer-dot[data-log-id="${logId}"]`);
    if (!dot) return;

    const modal = document.getElementById('questionModal');
    const questionContent = document.getElementById('questionContent');
    const answerOptions = document.getElementById('answerOptions');
    const questionStatusBadge = document.getElementById('questionStatusBadge');
    const questionTime = document.getElementById('questionTime');

    // 获取题目数据
    const questionText = dot.getAttribute('data-question');
    const selectedOption = dot.getAttribute('data-selected-option');
    const correctOption = dot.getAttribute('data-correct-option');
    const status = dot.getAttribute('data-status');
    const time = dot.getAttribute('data-time');

    // 解析选项数据
    let options = [];
    try {
        options = JSON.parse(dot.getAttribute('data-options'));
    } catch (e) {
        options = [];
    }

    // 设置状态标签
    let statusText = '';
    let badgeClass = '';
    if (status === 'correct') {
        statusText = '正确';
        badgeClass = 'bg-success';
    } else if (status === 'incorrect') {
        statusText = '错误';
        badgeClass = 'bg-danger';
    } else {
        statusText = '未批改';
        badgeClass = 'bg-secondary';
    }

    questionStatusBadge.className = `question-status-badge badge ${badgeClass}`;
    questionStatusBadge.textContent = statusText;

    // 设置时间
    const timeObj = new Date(time);
    questionTime.textContent = timeObj.toLocaleString('zh-CN');

    // 设置题目内容
    questionContent.innerHTML = `
        <h6>题目：</h6>
        <div class="p-3 bg-light rounded">${questionText || '题目内容加载中...'}</div>
    `;

    // 清空并重新设置选项
    answerOptions.innerHTML = '';
    if (options && options.length > 0) {
        answerOptions.innerHTML = '<h6>选项：</h6>';
        options.forEach((option, index) => {
            const optionDiv = document.createElement('div');
            optionDiv.className = 'answer-option';

            // 检查是否是这个选项
            let isSelected = false;
            let isCorrect = false;

            if (selectedOption && option.includes(selectedOption)) {
                isSelected = true;
            }

            if (correctOption && option.includes(correctOption)) {
                isCorrect = true;
            }

            // 添加相应的类
            if (isSelected && isCorrect) {
                optionDiv.classList.add('selected', 'correct');
            } else if (isSelected && !isCorrect) {
                optionDiv.classList.add('selected', 'incorrect');
            } else if (!isSelected && isCorrect) {
                optionDiv.classList.add('correct');
            }

            optionDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <span class="me-2">${String.fromCharCode(65 + index)}.</span>
                    <div class="flex-grow-1">${option}</div>
                    ${isSelected ? '<span class="badge bg-info ms-2">您的选择</span>' : ''}
                    ${isCorrect ? '<span class="badge bg-success ms-2">正确答案</span>' : ''}
                </div>
            `;

            answerOptions.appendChild(optionDiv);
        });
    } else {
        answerOptions.innerHTML = '<p class="text-muted">选项信息不可用</p>';
    }

    // 显示模态框
    modal.style.display = 'block';
}

// 关闭题目详情模态框
function closeQuestionModal() {
    const modal = document.getElementById('questionModal');
    modal.style.display = 'none';
    currentQuestionIndex = 0;
    currentQuestions = [];
}

// 加载当前习题的所有答题记录
function loadExerciseQuestions(exerciseId) {
    const dots = document.querySelectorAll(`.answer-grid[data-exercise-id="${exerciseId}"] .answer-dot`);
    currentQuestions = Array.from(dots).map(dot => ({
        logId: dot.getAttribute('data-log-id'),
        questionText: dot.getAttribute('data-question'),
        selectedOption: dot.getAttribute('data-selected-option'),
        correctOption: dot.getAttribute('data-correct-option'),
        options: dot.getAttribute('data-options'),
        status: dot.getAttribute('data-status'),
        time: dot.getAttribute('data-time')
    }));

    if (currentQuestions.length > 0) {
        currentQuestionIndex = 0;
        showQuestion(currentQuestionIndex);
    }
}

// 显示指定索引的题目
function showQuestion(index) {
    if (index < 0 || index >= currentQuestions.length) return;

    currentQuestionIndex = index;
    const question = currentQuestions[index];

    // 更新按钮状态
    document.getElementById('prevQuestionBtn').disabled = index === 0;
    document.getElementById('nextQuestionBtn').disabled = index === currentQuestions.length - 1;

    // 显示题目
    showQuestionModal(question.logId);
}

// 初始化事件监听
document.addEventListener('DOMContentLoaded', function() {
    // 点击答题点
    document.querySelectorAll('.answer-dot').forEach(dot => {
        dot.addEventListener('click', function() {
            const logId = this.getAttribute('data-log-id');
            if (logId) {
                // 加载该习题的所有题目
                const exerciseId = this.closest('.answer-grid').getAttribute('data-exercise-id');
                loadExerciseQuestions(exerciseId);

                // 找到当前点击的题目索引
                const dots = Array.from(this.closest('.answer-grid').querySelectorAll('.answer-dot'));
                const clickedIndex = dots.findIndex(d => d.getAttribute('data-log-id') === logId);
                currentQuestionIndex = clickedIndex;

                showQuestionModal(logId);
            }
        });
    });

    // 点击查看详情按钮
    document.querySelectorAll('.view-details-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const exerciseId = this.getAttribute('data-exercise-id');
            loadExerciseQuestions(exerciseId);
        });
    });

    // 上一题按钮
    document.getElementById('prevQuestionBtn').addEventListener('click', function() {
        if (currentQuestionIndex > 0) {
            showQuestion(currentQuestionIndex - 1);
        }
    });

    // 下一题按钮
    document.getElementById('nextQuestionBtn').addEventListener('click', function() {
        if (currentQuestionIndex < currentQuestions.length - 1) {
            showQuestion(currentQuestionIndex + 1);
        }
    });

    // 点击模态框外部关闭
    document.getElementById('questionModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeQuestionModal();
        }
    });

    // ESC键关闭模态框
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeQuestionModal();
        }
    });

    // 移动设备侧边栏切换
    if (window.innerWidth < 768) {
        const sidebar = document.querySelector('.student-sidebar');
        const toggleBtn = document.createElement('button');

        toggleBtn.className = 'btn btn-primary btn-sm';
        toggleBtn.innerHTML = '<i class="fas fa-bars"></i>';
        toggleBtn.style.position = 'fixed';
        toggleBtn.style.top = '80px';
        toggleBtn.style.right = '20px';
        toggleBtn.style.zIndex = '1000';

        let sidebarVisible = false;
        toggleBtn.addEventListener('click', function() {
            sidebarVisible = !sidebarVisible;
            sidebar.style.display = sidebarVisible ? 'block' : 'none';
        });

        document.body.appendChild(toggleBtn);
        sidebar.style.display = 'none';
    }
});
</script>
{% endblock %}