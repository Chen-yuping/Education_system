<!-- templates/student/knowledge_diagnosis.html -->
{% extends 'student/base.html' %}
{% load static %}

{% block title %}知识点诊断 - 在线学习诊断系统{% endblock %}

{% block content %}
<style>
    /* 节点样式 */
    .node circle {
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .node:hover circle {
        filter: brightness(1.2);
    }

    /* 箭头样式 */
    marker#arrow path {
        fill: #999;
    }

    /* 工具提示 */
    .tooltip {
        position: absolute;
        background: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 12px 15px;
        border-radius: 6px;
        font-size: 14px;
        pointer-events: none;
        z-index: 100;
        max-width: 300px;
        box-shadow: 0 3px 15px rgba(0,0,0,0.3);
        display: none;
    }

    .tooltip h6 {
        margin: 0 0 5px 0;
        color: #ffcc00;
        font-weight: bold;
        border-bottom: 1px solid rgba(255,255,255,0.2);
        padding-bottom: 5px;
    }

    .tooltip p {
        margin: 3px 0;
        font-size: 13px;
    }

    .progress-thin {
        height: 6px;
        margin: 5px 0;
    }
    .node circle {
        stroke: #fff;
        stroke-width: 2px;
        transition: all 0.3s ease;
    }

    .node:hover circle {
        stroke-width: 3px;
        cursor: pointer;
    }

    .node text {
        font: 10px sans-serif;
        fill: white;
        font-weight: bold;
        text-anchor: middle;
        pointer-events: none;
    }

    #graphContainer {
        position: relative;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
        background-color: #f8f9fa;
    }

    #chart {
        width: 100%;
        height: 100%;
    }

    svg {
        display: block;
    }
    .knowledge-diagnosis-container {
        width: 90%;
        height: 400px;
        border: 1px solid #e9ecef;
        border-radius: 5px;
        position: relative;
        overflow: hidden;
    }

    .node circle {
        stroke-width: 2px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .node text {
        font: 12px sans-serif;
        fill: white;
        font-weight: bold;
        pointer-events: none;
        text-anchor: middle;
        dominant-baseline: central;
    }



    .node:hover circle {
        stroke-width: 3px;
        filter: brightness(1.2);
    }

    .tooltip {
        position: absolute;
        background: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 12px 15px;
        border-radius: 6px;
        font-size: 14px;
        pointer-events: none;
        z-index: 100;
        max-width: 300px;
        box-shadow: 0 3px 15px rgba(0,0,0,0.3);
        /* 移除 transition: opacity 0.2s; 或者确保opacity为1 */
        display: none;  /* 这个由JavaScript控制 */
    }

    /* 确保显示时完全可见 */
    .tooltip[style*="display: block"] {
        opacity: 1 !important;
        visibility: visible !important;
    }

    .tooltip h6 {
        margin: 0 0 5px 0;
        color: #ffcc00;
        font-weight: bold;
        border-bottom: 1px solid rgba(255,255,255,0.2);
        padding-bottom: 5px;
    }

    .tooltip p {
        margin: 3px 0;
        font-size: 13px;
    }

    .progress-thin {
        height: 6px;
        margin: 5px 0;
    }

    .legend-box {
        width: 15px;
        height: 15px;
        display: inline-block;
        margin-right: 5px;
        border-radius: 3px;
    }

    .mastery-card {
        transition: all 0.3s ease;
    }

    .mastery-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    #graphContainer {
        width: 100%;
        height: 600px;
        border: 2px solid #e9ecef;  /* 加粗边框 */
        border-radius: 8px;
        position: relative;
        overflow: hidden;
        background-color: #f8f9fa;  /* 添加背景色 */
    }

    #chart {
        width: 100%;
        height: 100%;
    }

    svg {
        display: block;
    }

    .node circle {
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .node:hover circle {
        transform: scale(1.1);
        filter: brightness(1.2);
    }


</style>

<!-- 页面标题栏 -->
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">知识点诊断图</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshData()">
                <i class="fas fa-sync-alt"></i> 刷新数据
            </button>
        </div>
    </div>
</div>

<!-- 科目选择器和统计信息 -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <div class="form-group mb-0">
                    <label for="subjectSelect" class="form-label fw-bold">选择科目</label>
                    <select class="form-select" id="subjectSelect">
                        <option value="">-- 请选择科目 --</option>
                        {% for subject in subjects %}
                        <option value="{{ subject.id }}"
                                {% if default_subject and subject.id == default_subject.id %}selected{% endif %}>
                            {{ subject.name }}
                        </option>
                        {% empty %}
                        <option value="" disabled>暂无选课记录</option>
                        {% endfor %}
                    </select>
                    <small class="text-muted mt-1 d-block">
                        学生: {{ user.username }} | 科目数: {{ subjects|length }}
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- 修改掌握程度统计部分 -->
    <div class="col-md-8">
        <div class="card h-100">
            <div class="card-body">
                <h6 class="card-title">掌握程度统计</h6>
                <div class="row text-center" id="masteryStats">
                    <div class="col-2">
                        <div class="mastery-card p-2 rounded bg-success bg-opacity-10">
                            <div class="text-success fw-bold" id="masteredCount">0</div>
                            <small class="text-muted">已掌握</small>
                        </div>
                    </div>
                    <div class="col-2">
                        <div class="mastery-card p-2 rounded bg-warning bg-opacity-10">
                            <div class="text-warning fw-bold" id="partialCount">0</div>
                            <small class="text-muted">基本掌握</small>
                        </div>
                    </div>
                    <div class="col-2">
                        <div class="mastery-card p-2 rounded bg-danger bg-opacity-10">
                            <div class="text-danger fw-bold" id="weakCount">0</div>
                            <small class="text-muted">需要加强</small>
                        </div>
                    </div>
                    <div class="col-2">
                        <div class="mastery-card p-2 rounded bg-primary bg-opacity-10">
                            <div class="text-primary fw-bold" id="beginnerCount">0</div>
                            <small class="text-muted">刚开始学</small>
                        </div>
                    </div>
                    <div class="col-2">
                        <div class="mastery-card p-2 rounded bg-secondary bg-opacity-10">
                            <div class="text-secondary fw-bold" id="noneCount">0</div>
                            <small class="text-muted">未学习</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- 知识点诊断图容器 -->
<div class="card mb-4">
    <div class="card-body p-0">
        <div id="graphContainer" class="knowledge-diagnosis-container">
            <!-- 加载状态 -->
            <div id="loading" style="position:absolute; top:0; left:0; width:100%; height:100%; display:none; flex-direction:column; justify-content:center; align-items:center; background:rgba(255,255,255,0.95); z-index:1000;">
                <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                <h5 class="mt-3 text-primary">正在加载诊断数据...</h5>
                <p id="loadingMessage" class="text-muted"></p>
            </div>

            <!-- 初始提示 -->
            <div id="initialMessage" style="position:absolute; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                <i class="fas fa-chart-line fa-3x text-primary mb-3"></i>
                <h5 class="text-primary">知识点掌握情况分析</h5>
                <p class="text-muted small">选择科目查看您的知识点掌握情况</p>
                <div class="alert alert-info mt-3" style="max-width: 400px;">
                    <small><i class="fas fa-info-circle me-2"></i>不同颜色代表不同掌握程度：绿色(已掌握)、橙色(基本掌握)、红色(需要加强)、灰色(未学习)</small>
                </div>
            </div>

            <!-- 工具提示 -->
            <div id="tooltip" class="tooltip"></div>

            <!-- D3.js图表区域 -->
            <div id="chart"></div>
        </div>
    </div>
</div>

<!-- 统计信息 -->
<div id="stats" class="mt-3 alert alert-info" style="display:none;">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <i class="fas fa-chart-bar me-2"></i>
            <span id="subjectName"></span>：
            共 <span id="nodeCount" class="fw-bold">0</span> 个知识点，<span id="linkCount" class="fw-bold">0</span> 个关系
        </div>
        <div class="text-muted small">
            <i class="fas fa-mouse-pointer me-1"></i>鼠标悬停查看详情 |
            <i class="fas fa-arrows-alt me-1"></i>拖拽节点 |
            <i class="fas fa-search me-1"></i>滚轮缩放
        </div>
    </div>
</div>

<!-- 图例和说明 -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title">图例说明</h6>
                <div class="row">
                    <div class="col-6">
                        <div class="mb-2">
                            <span class="legend-box" style="background-color: #2ecc71;"></span>
                            <small>掌握良好 (≥80%)</small>
                        </div>
                        <div class="mb-2">
                            <span class="legend-box" style="background-color: #f39c12;"></span>
                            <small>基本掌握 (60%-80%)</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="mb-2">
                            <span class="legend-box" style="background-color: #e74c3c;"></span>
                            <small>需要加强 (40%-60%)</small>
                        </div>
                        <div class="mb-2">
                            <span class="legend-box" style="background-color: #95a5a6;"></span>
                            <small>未学习/未掌握 (<40%)</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title">操作指南</h6>
                <ul class="list-unstyled mb-0">
                    <li><small><i class="fas fa-mouse-pointer text-primary me-2"></i>鼠标悬停查看知识点详情</small></li>
                    <li><small><i class="fas fa-arrows-alt text-primary me-2"></i>拖拽节点调整布局</small></li>
                    <li><small><i class="fas fa-search text-primary me-2"></i>使用鼠标滚轮缩放视图</small></li>
                    <li><small><i class="fas fa-sync-alt text-primary me-2"></i>选择不同科目查看其他诊断</small></li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- 引入D3.js -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<script>

// 全局变量
let simulation, currentData = {};

// 页面加载完成
document.addEventListener('DOMContentLoaded', function() {
    console.log('学生诊断页面加载完成');

    // 初始化时隐藏统计信息
    document.getElementById('stats').style.display = 'none';

    // 检查是否有默认选中的科目
    const select = document.getElementById('subjectSelect');
    if (select && select.value) {
        console.log('有默认科目，自动加载:', select.value);
        loadDiagnosisData();
    }
});

// 刷新数据
function refreshData() {
    const select = document.getElementById('subjectSelect');
    if (select && select.value) {
        loadDiagnosisData();
    }
}

// 加载诊断数据
function loadDiagnosisData() {
    const subjectId = document.getElementById('subjectSelect').value;
    if (!subjectId) {
        // 清空图表
        d3.select('#chart').html('');
        document.getElementById('initialMessage').style.display = 'flex';
        document.getElementById('stats').style.display = 'none';
        resetStats();
        return;
    }

    console.log('加载科目ID:', subjectId);

    // 显示加载中
    const loading = document.getElementById('loading');
    const loadingMessage = document.getElementById('loadingMessage');
    loadingMessage.textContent = `正在加载您的知识点掌握情况...`;
    loading.style.display = 'flex';
    document.getElementById('initialMessage').style.display = 'none';

    // 隐藏统计信息
    document.getElementById('stats').style.display = 'none';

    // 清空之前的图表
    d3.select('#chart').html('');

    // ==== 关键修改：使用正确的API路径 ====
    // 根据你的urls.py配置，路径应该是：/learning/api/knowledge-points/{subject_id}/
    const apiUrl = `/learning/student/api/knowledge-points/${subjectId}/`;
    console.log('调用API:', apiUrl);

    fetch(apiUrl, {
        method: 'GET',
        headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json',
        },
        credentials: 'include'  // 重要：确保发送cookie用于身份验证
    })
        .then(response => {
            console.log('API响应状态:', response.status, response.statusText);
            console.log('响应URL:', response.url);

            if (response.status === 401) {
                throw new Error('请先登录');
            }
            if (response.status === 403) {
                throw new Error('无权限访问，请确认您是学生身份');
            }
            if (response.status === 404) {
                throw new Error('API路径不存在，请检查URL配置');
            }
            if (!response.ok) {
                throw new Error(`HTTP错误: ${response.status} ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('收到数据:', data);

            // 隐藏加载状态
            loading.style.display = 'none';

            if (data.status === 'success') {
                currentData = data;

                // 更新掌握程度统计
                updateMasteryStats(data.mastery_stats);

                // 显示知识点统计信息
                document.getElementById('nodeCount').textContent = data.node_count;
                document.getElementById('linkCount').textContent = data.link_count;
                document.getElementById('subjectName').textContent = data.subject_name;
                document.getElementById('stats').style.display = 'block';

                // 绘制图表
                renderDiagnosisGraph(data);
            } else {
                throw new Error(data.message || 'API返回失败状态');
            }
        })
        .catch(error => {
            console.error('加载失败:', error);
            loading.innerHTML = `
                <i class="fas fa-exclamation-triangle text-danger fa-3x mb-3"></i>
                <h5 class="text-danger">加载失败</h5>
                <p class="text-muted">${error.message}</p>
                <p class="text-muted small">API路径: ${apiUrl}</p>
                <p class="text-muted small">科目ID: ${subjectId}</p>
                <p class="text-muted small">当前用户: {{ user.username }}</p>
                <button class="btn btn-sm btn-primary mt-2" onclick="loadDiagnosisData()">重试</button>
            `;
        });
}

// 更新掌握程度统计
function updateMasteryStats(stats) {
    if (!stats) return;
    document.getElementById('masteredCount').textContent = stats.mastered || 0;
    document.getElementById('partialCount').textContent = stats.partial || 0;
    document.getElementById('weakCount').textContent = stats.weak || 0;
    document.getElementById('noneCount').textContent = stats.none || 0;
}

// 重置统计信息
function resetStats() {
    document.getElementById('masteredCount').textContent = '0';
    document.getElementById('partialCount').textContent = '0';
    document.getElementById('weakCount').textContent = '0';
    document.getElementById('noneCount').textContent = '0';
}

// 绘图
function renderDiagnosisGraph(data) {
    console.log('=== 绘制知识点关系图（带箭头）===');

    const container = document.getElementById('graphContainer');
    const width = container.clientWidth;
    const height = container.clientHeight;

    // 清空图表
    d3.select('#chart').html('');

    // 如果没有节点数据
    if (!data.nodes || data.nodes.length === 0) {
        console.log('没有节点数据');
        const chart = document.getElementById('chart');
        if (chart) {
            chart.innerHTML = `
                <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); text-align:center;">
                    <i class="fas fa-database fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">暂无知识点数据</h5>
                    <p class="text-muted small">该科目暂无知识点定义</p>
                </div>
            `;
        }
        return;
    }

    // 创建SVG
    const svg = d3.select('#chart')
        .append('svg')
        .attr('width', width)
        .attr('height', height)
        .attr('viewBox', [0, 0, width, height])
        .call(d3.zoom()
            .scaleExtent([0.1, 4])
            .on('zoom', function(event) {
                g.attr('transform', event.transform);
            }))
        .append('g');

    const g = svg.append('g');

    // 添加箭头定义
    const defs = svg.append('defs');

    // 单向箭头
    defs.append('marker')
        .attr('id', 'arrow')
        .attr('viewBox', '0 -5 10 10')
        .attr('refX', 30)  // 箭头距离目标节点的距离
        .attr('refY', 0)
        .attr('markerWidth', 6)
        .attr('markerHeight', 6)
        .attr('orient', 'auto')
        .append('path')
        .attr('d', 'M0,-5L10,0L0,5')
        .attr('fill', '#999');

    // 处理节点
    const nodes = data.nodes.map((node, i) => ({
        ...node,
        x: width / 2 + Math.cos(i * 2 * Math.PI / data.nodes.length) * 150,
        y: height / 2 + Math.sin(i * 2 * Math.PI / data.nodes.length) * 150
    }));

    // 处理链接
    const links = data.links.map(link => ({
        ...link,
        source: nodes[link.source],
        target: nodes[link.target]
    }));

    console.log('节点:', nodes);
    console.log('链接:', links);

    // 修正后的力模拟设置
    const simulation = d3.forceSimulation(nodes)
        .force('link', d3.forceLink(links)
            .id(d => d.id)
            .distance(150)        // 增加距离，让节点更分散
            .strength(0.8))       // 增加链接强度
        .force('charge', d3.forceManyBody()
            .strength(-200)       // 减小排斥力强度（原来是-300）
            .distanceMax(200))    // 限制最大作用距离
        .force('center', d3.forceCenter(width / 2, height / 2)
            .strength(0.2))       // 增加中心引力强度
        .force('collision', d3.forceCollide()
            .radius(50)           // 增加碰撞半径
            .strength(1.0))       // 增加碰撞强度
        .force('x', d3.forceX(width / 2).strength(0.1))  // 添加X轴约束
        .force('y', d3.forceY(height / 2).strength(0.1))  // 添加Y轴约束
        .alphaDecay(0.05)         // 加快衰减
        .velocityDecay(0.6)       // 增加速度衰减
        .alpha(0.5);              // 设置初始alpha值

    // 绘制链接
    const link = g.append('g')
        .attr('class', 'links')
        .selectAll('line')
        .data(links)
        .enter()
        .append('line')
        .attr('class', 'link')
        .attr('stroke', '#bdc3c7')
        .attr('stroke-width', 2)
        .attr('stroke-opacity', 0.7)
        .attr('stroke-dasharray', 'none')  // 全部实线
        .attr('marker-end', d => d.bidirectional ? null : 'url(#arrow)');  // 单向保留箭头

    // 绘制节点
    const node = g.append('g')
        .attr('class', 'nodes')
        .selectAll('circle')
        .data(nodes)
        .enter()
        .append('circle')
        .attr('r', 25)
        .attr('fill', d => d.color)
        .attr('stroke', '#fff')
        .attr('stroke-width', 2)
        .call(d3.drag()
            .on('start', dragstarted)
            .on('drag', dragged)
            .on('end', dragended));

    // 添加节点标签
    const label = g.append('g')
        .attr('class', 'labels')
        .selectAll('text')
        .data(nodes)
        .enter()
        .append('text')
        .text(d => d.name)
        .attr('text-anchor', 'middle')
        .attr('dy', '0.35em')
        .attr('fill', 'white')
        .style('font-size', '11px')
        .style('font-weight', 'bold')
        .style('pointer-events', 'none');

    // 力模拟的tick事件
    simulation.on('tick', () => {
        // 更新链接位置
        link
            .attr('x1', d => d.source.x)
            .attr('y1', d => d.source.y)
            .attr('x2', d => d.target.x)
            .attr('y2', d => d.target.y);

        // 更新节点位置
        node
            .attr('cx', d => {
                // 限制在边界内
                d.x = Math.max(30, Math.min(width - 30, d.x));
                return d.x;
            })
            .attr('cy', d => {
                d.y = Math.max(30, Math.min(height - 30, d.y));
                return d.y;
            });

        // 更新标签位置
        label
            .attr('x', d => d.x)
            .attr('y', d => d.y);
    });

    // 拖拽函数
    function dragstarted(event) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        event.subject.fx = event.subject.x;
        event.subject.fy = event.subject.y;
    }

    function dragged(event) {
        event.subject.fx = event.x;
        event.subject.fy = event.y;
    }

    function dragended(event) {
        if (!event.active) simulation.alphaTarget(0);
        event.subject.fx = null;
        event.subject.fy = null;
    }
       // 在事件处理函数外部保存需要的变量引用
    const currentLinks = link;  // 保存link引用
    const currentContainer = container;  // 保存container引用

    // 节点悬停效果
    node.on('mouseover', function(event) {
        console.log('mouseover事件触发');

        const d = d3.select(this).datum();  // 获取数据
        if (!d) {
            console.error('无法获取节点数据');
            return;
        }

        console.log('节点数据:', d);

        // 高亮当前节点
        d3.select(this)
            .transition()
            .duration(200)
            .attr('stroke-width', 3)
            .attr('stroke', '#3498db');

        // 高亮相关链接 - 使用保存的currentLinks
        if (currentLinks) {
            currentLinks.style('stroke', function(l) {
                if (l.source.id === d.id || l.target.id === d.id) {
                    return '#3498db';
                }
                const avg = l.avg_mastery || 0;
                return '#999';
            })
            .style('stroke-width', function(l) {
                return (l.source.id === d.id || l.target.id === d.id) ? 3 : 2;
            });
        }

        // 显示工具提示
        const tooltip = document.getElementById('tooltip');
        if (tooltip && currentContainer) {
            const masteryPercent = d.mastery_percent || Math.round((d.mastery_level || 0) * 100);
            const accuracy = d.accuracy || 0;

            tooltip.innerHTML = `
                <h6>${d.full_name || d.name}</h6>
                <p><strong>掌握程度:</strong> ${masteryPercent}%</p>
                <div class="progress progress-thin">
                    <div class="progress-bar" role="progressbar"
                         style="width: ${masteryPercent}%; background-color: ${d.color};">
                    </div>
                </div>
                <p><strong>练习次数:</strong> ${d.practice_count || 0}</p>
                <p><strong>正确次数:</strong> ${d.correct_count || 0}</p>
                <p><strong>正确率:</strong> ${accuracy.toFixed(1)}%</p>
                ${d.last_practiced ? `<p><strong>最后练习:</strong> ${d.last_practiced}</p>` : ''}
            `;

            const rect = currentContainer.getBoundingClientRect();
            tooltip.style.left = (event.clientX - rect.left + 15) + 'px';
            tooltip.style.top = (event.clientY - rect.top - 100) + 'px';
            tooltip.style.display = 'block';
        }
    });

    node.on('mouseout', function(event) {
        console.log('mouseout事件触发');

        // 恢复节点样式
        d3.select(this)
            .transition()
            .duration(200)
            .attr('stroke-width', 2)
            .attr('stroke', '#fff');

        // 恢复链接样式
        if (currentLinks) {
            currentLinks.style('stroke', '#999')
            .style('stroke-width', 2);
        }

        // 隐藏工具提示
        const tooltip = document.getElementById('tooltip');
        if (tooltip) tooltip.style.display = 'none';
    });

    console.log('图表绘制完成');
}

// 显示工具提示函数
function showTooltip(event, node) {
    const tooltip = document.getElementById('tooltip');
    if (!tooltip) return;

    const masteryPercent = node.mastery_percent || (node.mastery_level * 100).toFixed(1);

    tooltip.innerHTML = `
        <h6>${node.full_name || node.name}</h6>
        <p><strong>掌握程度:</strong> ${masteryPercent}%</p>
        <div class="progress progress-thin">
            <div class="progress-bar" role="progressbar"
                 style="width: ${masteryPercent}%; background-color: ${node.color};">
            </div>
        </div>
        <p><strong>练习次数:</strong> ${node.practice_count || 0}</p>
        <p><strong>正确次数:</strong> ${node.correct_count || 0}</p>
        <p><strong>正确率:</strong> ${node.accuracy || 0}%</p>
        ${node.last_practiced ? `<p><strong>最后练习:</strong> ${node.last_practiced}</p>` : ''}
    `;

    const container = document.getElementById('graphContainer');
    const rect = container.getBoundingClientRect();

    tooltip.style.left = (event.clientX - rect.left + 15) + 'px';
    tooltip.style.top = (event.clientY - rect.top - 100) + 'px';
    tooltip.style.display = 'block';
}

function hideTooltip() {
    const tooltip = document.getElementById('tooltip');
    if (tooltip) {
        tooltip.style.display = 'none';
    }
}

// 拖拽函数
function dragstarted(event) {
    if (!event.active) simulation.alphaTarget(0.3).restart();
    event.subject.fx = event.subject.x;
    event.subject.fy = event.subject.y;
}

function dragged(event) {
    event.subject.fx = event.x;
    event.subject.fy = event.y;
}

function dragended(event) {
    if (!event.active) simulation.alphaTarget(0);
    event.subject.fx = null;
    event.subject.fy = null;
}

// 更新掌握程度统计
function updateMasteryStats(stats) {
    if (!stats) return;
    document.getElementById('masteredCount').textContent = stats.mastered || 0;
    document.getElementById('partialCount').textContent = stats.partial || 0;
    document.getElementById('weakCount').textContent = stats.weak || 0;
    document.getElementById('beginnerCount').textContent = stats.beginner || 0;  // 新增
    document.getElementById('noneCount').textContent = stats.none || 0;
}

// 重置统计信息
function resetStats() {
    document.getElementById('masteredCount').textContent = '0';
    document.getElementById('partialCount').textContent = '0';
    document.getElementById('weakCount').textContent = '0';
    document.getElementById('beginnerCount').textContent = '0';  // 新增
    document.getElementById('noneCount').textContent = '0';
}

// 窗口大小变化时重绘
// 等待页面完全加载
document.addEventListener('DOMContentLoaded', function() {
    console.log('页面加载完成，开始绑定事件...');

    const subjectSelect = document.getElementById('subjectSelect');
    if (subjectSelect) {
        console.log('找到科目选择器，绑定change事件');

        // 绑定change事件
        subjectSelect.addEventListener('change', function() {
            console.log('科目选择器change事件触发，值:', this.value);
            if (typeof loadDiagnosisData === 'function') {
                loadDiagnosisData();
            } else {
                console.error('loadDiagnosisData函数未定义');
            }
        });

        console.log('事件绑定完成');
    } else {
        console.error('未找到科目选择器');
    }
});
</script>
{% endblock %}


