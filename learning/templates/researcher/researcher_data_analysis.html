{% extends 'researcher/researcher-base.html' %}
{% load static %}

{% block title %}数据集分析 - 在线学习诊断系统{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
{% endblock %}

{% block content %}
<style>
    .filter-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .chart-container {
        position: relative;
        height: 400px;
        margin-bottom: 30px;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }

    .data-table {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        overflow: hidden;
    }

    .data-table table {
        margin-bottom: 0;
    }

    .data-table thead {
        background: #f8f9fa;
    }

    .stat-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .stat-item {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }

    .stat-item-label {
        font-size: 0.85rem;
        color: #6c757d;
        margin-bottom: 8px;
    }

    .stat-item-value {
        font-size: 1.8rem;
        font-weight: bold;
        color: #007bff;
    }

    .pagination {
        margin-top: 20px;
        justify-content: center;
    }

    .no-data {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
    }

    .no-data i {
        font-size: 2rem;
        margin-bottom: 10px;
        opacity: 0.5;
    }
</style>


<!-- 统计概览 -->
<div class="stat-row">
    <div class="stat-item">
        <div class="stat-item-label">
            <i class="fas fa-book me-2"></i>科目总数
        </div>
        <div class="stat-item-value">{{ total_subjects }}</div>
    </div>
    <div class="stat-item">
        <div class="stat-item-label">
            <i class="fas fa-dumbbell me-2"></i>习题总数
        </div>
        <div class="stat-item-value">{{ total_exercises }}</div>
    </div>
    <div class="stat-item">
        <div class="stat-item-label">
            <i class="fas fa-brain me-2"></i>知识点总数
        </div>
        <div class="stat-item-value">{{ total_knowledge_points }}</div>
    </div>
    <div class="stat-item">
        <div class="stat-item-label">
            <i class="fas fa-check-circle me-2"></i>答题记录
        </div>
        <div class="stat-item-value">{{ total_answers }}</div>
    </div>
</div>

<!-- 图表区域 -->
<div class="row">
    <div class="col-lg-6">
        <div class="chart-container">
            <canvas id="exerciseChart"></canvas>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="chart-container">
            <canvas id="knowledgeChart"></canvas>
        </div>
    </div>
</div>

<!-- 筛选区域 -->
<div class="filter-section">
    <form method="get" id="filterForm">
        <div class="row">
            <div class="col-md-4">
                <label class="form-label">选择科目</label>
                <select class="form-select" name="subject" id="subjectFilter">
                    <option value="">全部科目</option>
                    {% for subject in all_subjects %}
                    <option value="{{ subject.id }}" {% if subject_filter|stringformat:"s" == subject.id|stringformat:"s" %}selected{% endif %}>
                        {{ subject.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">数据类型</label>
                <select class="form-select" name="data_type" id="dataTypeFilter">
                    <option value="all" {% if data_type_filter == "all" %}selected{% endif %}>全部数据</option>
                    <option value="exercises" {% if data_type_filter == "exercises" %}selected{% endif %}>习题数据</option>
                    <option value="knowledge" {% if data_type_filter == "knowledge" %}selected{% endif %}>知识点数据</option>
                    <option value="answers" {% if data_type_filter == "answers" %}selected{% endif %}>答题数据</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">&nbsp;</label>
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-search me-2"></i>查询
                </button>
            </div>
        </div>
    </form>
</div>

<!-- 数据表格 -->
<div class="data-table">
    <table class="table table-hover">
        <thead>
            <tr>
                <th>科目名称</th>
                <th>习题数</th>
                <th>知识点数</th>
                <th>答题记录</th>
                <th>平均正确率</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="dataTableBody">
            {% if page_obj %}
                {% for subject in page_obj %}
                <tr>
                    <td>
                        <strong>{{ subject.name }}</strong>
                    </td>
                    <td>
                        <span class="badge bg-primary">{{ subject.exercise_set.count }}</span>
                    </td>
                    <td>
                        <span class="badge bg-success">{{ subject.knowledgepoint_set.count }}</span>
                    </td>
                    <td>
                        <span class="badge bg-info">{{ subject.answer_count|default:0 }}</span>
                    </td>
                    <td>
                        <span class="badge bg-warning">{{ subject.avg_correct_rate|default:"0" }}%</span>
                    </td>
                    <td>
                        <a href="#" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye"></i> 详情
                        </a>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="6">
                        <div class="no-data">
                            <i class="fas fa-inbox"></i>
                            <p>暂无数据</p>
                        </div>
                    </td>
                </tr>
            {% endif %}
        </tbody>
    </table>

    <!-- 分页 -->
    {% if page_obj.paginator.num_pages > 1 %}
    <nav aria-label="Page navigation">
        <ul class="pagination">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1{% if subject_filter %}&subject={{ subject_filter }}{% endif %}{% if data_type_filter and data_type_filter != 'all' %}&data_type={{ data_type_filter }}{% endif %}">首页</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if subject_filter %}&subject={{ subject_filter }}{% endif %}{% if data_type_filter and data_type_filter != 'all' %}&data_type={{ data_type_filter }}{% endif %}">上一页</a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link">首页</span>
            </li>
            <li class="page-item disabled">
                <span class="page-link">上一页</span>
            </li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                </li>
                {% else %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}{% if subject_filter %}&subject={{ subject_filter }}{% endif %}{% if data_type_filter and data_type_filter != 'all' %}&data_type={{ data_type_filter }}{% endif %}">{{ num }}</a>
                </li>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if subject_filter %}&subject={{ subject_filter }}{% endif %}{% if data_type_filter and data_type_filter != 'all' %}&data_type={{ data_type_filter }}{% endif %}">下一页</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if subject_filter %}&subject={{ subject_filter }}{% endif %}{% if data_type_filter and data_type_filter != 'all' %}&data_type={{ data_type_filter }}{% endif %}">末页</a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link">下一页</span>
            </li>
            <li class="page-item disabled">
                <span class="page-link">末页</span>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 习题分布图
    const exerciseCtx = document.getElementById('exerciseChart').getContext('2d');
    new Chart(exerciseCtx, {
        type: 'doughnut',
        data: {
            labels: [
                {% for subject in all_subjects %}'{{ subject.name }}'{% if not forloop.last %},{% endif %}{% endfor %}
            ],
            datasets: [{
                data: [
                    {% for subject in all_subjects %}{{ subject.exercise_set.count }}{% if not forloop.last %},{% endif %}{% endfor %}
                ],
                backgroundColor: [
                    '#667eea', '#764ba2', '#f093fb', '#4facfe',
                    '#43e97b', '#fa709a', '#30cfd0', '#330867'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                title: {
                    display: true,
                    text: '各科目习题分布'
                }
            }
        }
    });

    // 知识点分布图
    const knowledgeCtx = document.getElementById('knowledgeChart').getContext('2d');
    new Chart(knowledgeCtx, {
        type: 'bar',
        data: {
            labels: [
                {% for subject in all_subjects %}'{{ subject.name }}'{% if not forloop.last %},{% endif %}{% endfor %}
            ],
            datasets: [{
                label: '知识点数',
                data: [
                    {% for subject in all_subjects %}{{ subject.knowledgepoint_set.count }}{% if not forloop.last %},{% endif %}{% endfor %}
                ],
                backgroundColor: '#667eea'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true
                },
                title: {
                    display: true,
                    text: '各科目知识点分布'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
});
</script>

{% endblock %}
