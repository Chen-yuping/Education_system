<!-- 左侧导航栏 -->
<nav class="teacher-sidebar">
    <div class="sidebar-nav">
        <!-- 左侧的上半部分 -->
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link {% if request.resolver_match.url_name == 'teacher_dashboard' %}active{% endif %}"
                   href="{% url 'teacher_dashboard' %}">
                    <i class="fas fa-tachometer-alt"></i> 教师面板
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if request.resolver_match.url_name == 'upload_exercise' %}active{% endif %}"
                   href="{% url 'upload_exercise' %}">
                    <i class="fas fa-upload"></i> 上传习题
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if request.resolver_match.url_name == 'upload_knowledge' %}active{% endif %}"
                   href="{% url 'upload_knowledge' %}">
                    <i class="fas fa-project-diagram"></i>知识点关系图
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if request.resolver_match.url_name == 'q_matrix_management' %}active{% endif %}"
                   >
                    <i class="fas fa-robot"></i> 学生诊断
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if request.resolver_match.url_name == 'q_matrix_management' %}active{% endif %}"
                   href="{% url 'exercise_management' %}">
                    <i class="fas fa-database"></i> 题库管理
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if request.resolver_match.url_name == 'student_info' %}active{% endif %}"
                   href="{% url 'student_info' %}">
                    <i class="fas fa-users"></i> 学生信息
                </a>
            </li>


        </ul>

        <!-- 科目管理部分 -->
        <h6 class="sidebar-heading">
            <span>科目管理</span>
            <button class="collapse-btn" type="button">
                <i class="fas fa-chevron-down"></i>
            </button>
        </h6>
        <div class="nav-collapse">
            <ul class="nav flex-column">
                {% for subject in subjects %}
                <li class="nav-item">
                    <a class="nav-link {% if request.resolver_match.url_name == 'exercise_list' and subject.id|stringformat:'s' in request.path %}active{% endif %}"
                       href="{% url 'exercise_list' subject.id %}">
                        <i class="fas fa-book"></i> {{ subject.name }}
                    </a>
                </li>
                {% empty %}
                <li class="nav-item">
                    <a class="nav-link text-muted" href="#">
                        <i class="fas fa-book"></i> 暂无科目
                    </a>
                </li>
                {% endfor %}
            </ul>
        </div>

    </div>
</nav>

<style>
    /* 侧边栏标题 */
    .sidebar-heading {
        font-size: 0.8rem;
        text-transform: uppercase;
        color: #6c757d;
        margin: 25px 0 10px 20px;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
    }

    .collapse-btn {
        background: none;
        border: none;
        color: #6c757d;
        cursor: pointer;
        padding: 0.25rem;
        transition: transform 0.3s ease;
        font-size: 0.7rem;
    }

    .collapse-btn.collapsed {
        transform: rotate(-90deg);
    }

    .nav-collapse {
        overflow: hidden;
        transition: max-height 0.3s ease;
        max-height: 500px; /* 设置一个足够大的值 */
    }

    .nav-collapse.collapsed {
        max-height: 0 !important;
    }

    /* 侧边栏导航链接样式 */
    .sidebar-nav .nav-link {
        padding: 12px 20px;
        color: #333;
        border-radius: 0;
        border-left: 3px solid transparent;
        transition: all 0.2s ease;
    }

    .sidebar-nav .nav-link:hover {
        background-color: #e9ecef;
        color: #007bff;
        border-left-color: #007bff;
    }

    .sidebar-nav .nav-link.active {
        background-color: #007bff;
        color: white;
        border-left-color: #007bff;
    }
</style>

<!-- 将移动设备侧边栏切换脚本放在这里 -->
<script>
// 移动设备侧边栏切换
document.addEventListener('DOMContentLoaded', function() {
    console.log('开始初始化侧边栏功能');

    // ========== 移动设备切换功能 ==========
    if (window.innerWidth < 768) {
        const sidebar = document.querySelector('.teacher-sidebar');
        const mainContent = document.querySelector('.teacher-main-content');

        // 创建切换按钮
        const toggleBtn = document.createElement('button');
        toggleBtn.className = 'btn btn-success btn-sm sidebar-toggle';
        toggleBtn.innerHTML = '<i class="fas fa-bars"></i>';
        toggleBtn.style.position = 'fixed';
        toggleBtn.style.top = '80px';
        toggleBtn.style.right = '20px';
        toggleBtn.style.zIndex = '1000';

        // 切换侧边栏显示
        let sidebarVisible = false;
        toggleBtn.addEventListener('click', function() {
            sidebarVisible = !sidebarVisible;
            sidebar.style.display = sidebarVisible ? 'block' : 'none';

            if (sidebarVisible) {
                mainContent.style.marginTop = '0';
            } else {
                mainContent.style.marginTop = '';
            }
        });

        document.body.appendChild(toggleBtn);
        sidebar.style.display = 'none';
    }

    // ========== 折叠按钮功能 ==========
    const collapseBtns = document.querySelectorAll('.collapse-btn');

    collapseBtns.forEach((btn, index) => {
        const heading = btn.closest('.sidebar-heading');
        const navCollapse = heading.nextElementSibling;

        if (!navCollapse) return;

        // ====== 重要修改：默认全部收起 ======
        // 所有折叠区域默认都收起
        btn.classList.add('collapsed');
        navCollapse.classList.add('collapsed');

        // 确保没有初始化标记冲突
        if (btn.classList.contains('initialized')) {
            return; // 已经初始化过，跳过
        }
        btn.classList.add('initialized');

        // 点击按钮切换
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            this.classList.toggle('collapsed');
            navCollapse.classList.toggle('collapsed');

            // 当展开时，确保显示所有内容
            if (!this.classList.contains('collapsed')) {
                navCollapse.style.maxHeight = navCollapse.scrollHeight + 'px';
            } else {
                navCollapse.style.maxHeight = '0';
            }
        });

        // 点击标题切换
        heading.addEventListener('click', function(e) {
            if (e.target !== btn) {
                e.stopPropagation();
                btn.classList.toggle('collapsed');
                navCollapse.classList.toggle('collapsed');

                if (!btn.classList.contains('collapsed')) {
                    navCollapse.style.maxHeight = navCollapse.scrollHeight + 'px';
                } else {
                    navCollapse.style.maxHeight = '0';
                }
            }
        });
    });

    // ========== 窗口大小改变事件 ==========
    window.addEventListener('resize', function() {
        const sidebar = document.querySelector('.teacher-sidebar');
        const toggleBtn = document.querySelector('.sidebar-toggle');

        if (window.innerWidth >= 768) {
            sidebar.style.display = 'block';
            if (toggleBtn) toggleBtn.remove();
        } else {
            sidebar.style.display = 'none';
        }

        // 重新计算展开区域的高度
        document.querySelectorAll('.nav-collapse').forEach(collapse => {
            if (!collapse.classList.contains('collapsed')) {
                collapse.style.maxHeight = collapse.scrollHeight + 'px';
            }
        });
    });
});
</script>